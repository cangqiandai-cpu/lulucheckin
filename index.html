<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>æ¯æ—¥æ‰“å¡</title>
  <style>
    :root{
      /* cute & coordinated palette */
      --ink:#1f2937;
      --muted:rgba(31,41,55,.62);
      --border:rgba(31,41,55,.10);
      --card:rgba(255,255,255,.86);
      --shadow:0 14px 34px rgba(31,41,55,.08);
      --bg:
        radial-gradient(1000px 600px at 10% 0%, rgba(255,210,226,.55) 0%, rgba(255,255,255,0) 60%),
        radial-gradient(900px 560px at 90% 10%, rgba(199,235,255,.55) 0%, rgba(255,255,255,0) 58%),
        radial-gradient(900px 560px at 50% 100%, rgba(205,255,231,.50) 0%, rgba(255,255,255,0) 60%),
        linear-gradient(180deg, rgba(248,250,252,1) 0%, rgba(255,255,255,1) 55%, rgba(248,250,252,1) 100%);

      /* task colors (RGB primaries, softened/pastel) */
      --c-workout: #ff3b5c; /* red */
      --c-art:     #22c55e; /* green */
      --c-read:    #3b82f6; /* blue */

      --pill: rgba(255,255,255,.72);
      --pill2: rgba(31,41,55,.06);
      --focus: rgba(31,41,55,.92);

      --radius-xl: 22px;
      --radius-lg: 18px;
      --radius-md: 14px;
      --radius-sm: 12px;

      --tap: 42px;
    }
    *{box-sizing:border-box}
    body{
      margin:0; min-height:100vh; background:var(--bg); color:var(--ink);
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
    }
    .wrap{max-width:1020px; margin:0 auto; padding:16px;}
    header{display:flex; justify-content:space-between; align-items:flex-start; gap:12px; flex-wrap:wrap;}
    .brand{display:flex; align-items:center; gap:10px;}
    .dot{width:10px;height:10px;border-radius:999px;background:var(--ink); box-shadow:0 6px 16px rgba(31,41,55,.18);}
    h1{margin:0; font-size:22px; letter-spacing:-.2px;}
    .badge{font-size:12px; padding:4px 10px; border-radius:999px; background:rgba(31,41,55,.07); display:inline-flex; align-items:center; gap:8px;}
    .sub{margin-top:6px; font-size:13px; color:rgba(31,41,55,.68);}
    .greet{
      margin-top:10px;
      padding:10px 12px;
      border-radius:999px;
      background:rgba(255,255,255,.72);
      border:1px solid var(--border);
      display:inline-flex;
      align-items:center;
      gap:10px;
      box-shadow:0 10px 24px rgba(31,41,55,.06);
      font-size:13px;
      color:rgba(31,41,55,.78);
    }
    .greet b{color:rgba(31,41,55,.95)}
    .btnrow{display:flex; gap:8px; align-items:center; flex-wrap:wrap;}
    button{font:inherit}
    .btn{
      border-radius:14px; padding:10px 12px; font-size:12px;
      border:1px solid var(--border); background:rgba(255,255,255,0);
      cursor:pointer; user-select:none;
      min-height: var(--tap);
    }
    .btn.primary{
      background:rgba(31,41,55,.88);
      color:white;
      border-color: rgba(31,41,55,.06);
      box-shadow:0 12px 26px rgba(31,41,55,.18);
    }
    .btn.secondary{background:rgba(31,41,55,.06);}
    .btn.icon{
      width: var(--tap);
      padding: 0;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      border-radius: 16px;
      background: rgba(255,255,255,.72);
    }
    .btn:active{transform: translateY(1px);}
    .card{
      background:var(--card); border:1px solid var(--border); border-radius:var(--radius-xl); padding:14px;
      box-shadow:var(--shadow); backdrop-filter: blur(10px);
    }
    .grid{display:grid; grid-template-columns: 1fr; gap:12px; margin-top:14px;}
    .monthTop{display:flex; justify-content:space-between; align-items:center; gap:10px; flex-wrap:wrap;}
    .monthTitle{font-size:16px; font-weight:900;}
    .monthMeta{font-size:12px; color:var(--muted); display:flex; gap:8px; align-items:center; flex-wrap:wrap;}
    .miniLegend{
      display:inline-flex; gap:8px; align-items:center; flex-wrap:wrap;
      padding:6px 10px; border-radius:999px; border:1px solid var(--border); background:var(--pill);
    }
    .dot3{display:inline-flex; gap:6px; align-items:center;}
    .d{width:10px;height:10px;border-radius:999px; box-shadow:0 8px 18px rgba(31,41,55,.10);}
    .d.r{background:var(--c-workout)}
    .d.g{background:var(--c-art)}
    .d.b{background:var(--c-read)}
    .dow{display:grid; grid-template-columns: repeat(7,1fr); gap:8px; margin:12px 0 8px;}
    .dow div{text-align:center; font-size:12px; color:rgba(31,41,55,.55);}
    .cal{display:grid; grid-template-columns: repeat(7,1fr); gap:8px;}
    .day{
      position:relative; height:46px; border-radius:16px; border:1px solid var(--border);
      overflow:hidden; cursor:pointer; text-align:left; padding:0;
      transition: transform .08s ease;
    }
    .day:active{transform: translateY(1px);}
    .day.sel{border:1.6px solid rgba(31,41,55,.86);}
    .dayInner{position:absolute; inset:0; padding:10px; display:flex; align-items:center; justify-content:space-between;}
    .dayNum{font-size:14px; font-weight:950;}
    .chip{
      font-size:12px; padding:2px 8px; border-radius:999px;
      background:rgba(255,255,255,.62); border:1px solid rgba(31,41,55,.08);
      display:inline-flex; align-items:center; gap:6px;
    }
    .chip .tiny{width:6px;height:6px;border-radius:999px;background:rgba(31,41,55,.28)}
    .todayTag{
      position:absolute; left:8px; bottom:6px; font-size:11px; padding:2px 8px; border-radius:999px;
      background:rgba(31,41,55,.88); color:white;
    }
    .taskDots{
      position:absolute; right:8px; bottom:7px; display:flex; gap:5px; align-items:center;
      background:rgba(255,255,255,.62);
      border:1px solid rgba(31,41,55,.08);
      border-radius:999px;
      padding:3px 7px;
    }
    .taskDots span{width:7px;height:7px;border-radius:999px; opacity:.25}
    .taskDots span.on{opacity:1}
    .legendRow{margin-top:12px; display:flex; justify-content:space-between; align-items:center; gap:10px; flex-wrap:wrap;}
    .pills{display:flex; gap:8px; align-items:center; flex-wrap:wrap;}
    .pill{
      font-size:12px; padding:7px 10px; border-radius:999px;
      border:1px solid var(--border); background:var(--pill);
    }
    .pill b{font-weight:950;}
    .stack{display:grid; grid-template-columns: 1fr; gap:12px;}
    .rowTop{display:flex; justify-content:space-between; align-items:center; gap:10px; flex-wrap:wrap;}
    .selDate{font-size:15px; font-weight:950;}
    .muted{font-size:13px; color:var(--muted);}
    .tog{display:flex; justify-content:space-between; align-items:center; gap:10px; width:100%;
      border-radius:20px; padding:12px; border:1px solid var(--border);
      background:rgba(255,255,255,.72); cursor:pointer;
      min-height: 56px;
    }
    .tog.on{background:rgba(31,41,55,.05);}
    .togLeft{display:flex; align-items:center; gap:10px;}
    .box{
      width:38px; height:38px; border-radius:16px; border:1px solid rgba(31,41,55,.12);
      display:flex; align-items:center; justify-content:center; font-weight:900;
      background:rgba(255,255,255,.92); color:rgba(31,41,55,.38);
    }
    .tog.on .box{background:rgba(31,41,55,.88); color:white;}
    .togName{font-size:14px; font-weight:950;}
    .togTag{
      font-size:12px; padding:6px 10px; border-radius:999px; border:1px solid var(--border);
      background:rgba(255,255,255,.85);
    }

    /* Sticky note (memo) */
    .noteShell{margin-top:12px;}
    .noteTop{display:flex; justify-content:space-between; align-items:center; gap:10px; flex-wrap:wrap;}
    .noteTitle{font-size:13px; font-weight:950;}
    .notePaper{
      margin-top:8px;
      position:relative;
      border-radius:18px;
      padding:14px 14px 12px;
      border:1px solid rgba(31,41,55,.10);
      background:
        linear-gradient(0deg, rgba(255,255,255,.7), rgba(255,255,255,.7)),
        repeating-linear-gradient(
          180deg,
          rgba(31,41,55,.00) 0px,
          rgba(31,41,55,.00) 18px,
          rgba(31,41,55,.07) 19px
        );
      box-shadow: 0 14px 30px rgba(31,41,55,.10);
      overflow:hidden;
    }
    .notePaper:before{
      content:"";
      position:absolute;
      top:-18px; left:16px;
      width:96px; height:36px;
      border-radius:999px;
      background: rgba(255, 214, 0, .18);
      border: 1px solid rgba(255, 214, 0, .22);
      transform: rotate(-6deg);
      box-shadow: 0 8px 18px rgba(31,41,55,.06);
    }
    .noteText{
      white-space:pre-wrap;
      line-height:1.6;
      font-size:13px;
      color: rgba(31,41,55,.84);
      min-height: 42px;
    }
    .noteHint{color: rgba(31,41,55,.45);}
    .noteEditArea{margin-top:8px; display:none;}
    .noteEditArea.show{display:block;}
    textarea{
      width:100%; min-height:110px; border-radius:16px; border:1px solid rgba(31,41,55,.12);
      padding:12px; font-size:14px; outline:none; background:rgba(255,255,255,.86);
      resize: vertical;
    }
    .noteBtns{margin-top:10px; display:flex; gap:8px; flex-wrap:wrap; justify-content:flex-end;}
    .noteBtns .btn{min-width: 88px;}

    pre{
      margin:10px 0 0; white-space:pre-wrap; font-size:13px; line-height:1.6;
      background:rgba(31,41,55,.05); border:1px solid rgba(31,41,55,.08);
      border-radius:18px; padding:12px;
    }
    .stats{margin-top:10px; display:grid; grid-template-columns: repeat(2,1fr); gap:10px;}
    .stat{
      border-radius:18px; border:1px solid var(--border); padding:12px; background:rgba(255,255,255,.76);
    }
    .statT{font-size:12px; color:var(--muted); font-weight:950;}
    .statV{margin-top:6px; font-size:22px; font-weight:980; letter-spacing:-.2px;}
    .statS{margin-top:2px; font-size:12px; color:rgba(31,41,55,.55);}
    .toast{
      position:fixed; left:50%; bottom:18px; transform:translateX(-50%);
      padding:10px 14px; border-radius:999px; background:rgba(31,41,55,.92);
      color:white; font-size:13px; box-shadow:0 14px 34px rgba(31,41,55,.28);
      display:none;
      z-index: 50;
    }
    .toast.show{display:block;}

    /* Settings modal (cute bottom sheet) */
    .modalMask{
      position:fixed; inset:0;
      background: rgba(15,23,42,.30);
      backdrop-filter: blur(6px);
      display:none;
      z-index: 60;
    }
    .modalMask.show{display:block;}
    .sheet{
      position:fixed; left:50%; bottom:14px;
      transform: translateX(-50%);
      width:min(980px, calc(100% - 20px));
      border-radius: 26px;
      background: rgba(255,255,255,.90);
      border: 1px solid rgba(31,41,55,.10);
      box-shadow: 0 20px 60px rgba(31,41,55,.26);
      padding: 14px;
      display:none;
      z-index: 70;
    }
    .sheet.show{display:block;}
    .sheetTop{display:flex; justify-content:space-between; align-items:center; gap:10px; flex-wrap:wrap;}
    .sheetTitle{font-size:15px; font-weight:980;}
    .sheetGrid{
      margin-top:12px;
      display:grid;
      grid-template-columns: 1fr;
      gap:10px;
    }
    .field{
      border-radius: 18px;
      border: 1px solid rgba(31,41,55,.10);
      background: rgba(255,255,255,.78);
      padding: 12px;
    }
    .field label{display:block; font-size:12px; color:var(--muted); font-weight:900;}
    .field input{
      width:100%;
      margin-top:6px;
      border-radius: 14px;
      border:1px solid rgba(31,41,55,.10);
      padding: 10px 10px;
      background: rgba(255,255,255,.90);
      font-size:14px;
      outline:none;
    }
    .toggleLine{
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      padding: 12px;
      border-radius: 18px;
      border: 1px solid rgba(31,41,55,.10);
      background: rgba(255,255,255,.78);
    }
    .toggleLine .tt{font-size:13px; font-weight:950;}
    .toggleLine .ts{font-size:12px; color:var(--muted); margin-top:2px;}
    .switch{
      width: 52px; height: 30px; border-radius: 999px;
      border: 1px solid rgba(31,41,55,.12);
      background: rgba(31,41,55,.10);
      position: relative;
      cursor:pointer;
      flex: 0 0 auto;
    }
    .switch:before{
      content:"";
      position:absolute; top: 3px; left: 3px;
      width: 24px; height: 24px;
      border-radius: 999px;
      background: rgba(255,255,255,.96);
      box-shadow: 0 10px 18px rgba(31,41,55,.16);
      transition: transform .16s ease;
    }
    .switch.on{
      background: rgba(31,41,55,.86);
    }
    .switch.on:before{transform: translateX(22px);}
    .sheetBtns{margin-top:12px; display:flex; justify-content:flex-end; gap:8px; flex-wrap:wrap;}
    .hintSmall{font-size:12px; color: rgba(31,41,55,.52); margin-top:10px;}
    @media (min-width: 900px){
      .grid{grid-template-columns: 1.2fr .8fr;}
      .sheetGrid{grid-template-columns: 1fr 1fr;}
    }
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div>
        <div class="brand">
          <span class="dot"></span>
          <h1>æ¯æ—¥æ‰“å¡</h1>
          <span class="badge">æœ¬åœ°ä¿å­˜</span>
        </div>
        <div class="sub">ä¸ç”¨æ¯å¤©æ»¡åˆ†ã€‚ä½ åšè¿‡çš„æ¯ä¸€æ­¥ï¼Œæˆ‘éƒ½ç®—æ•°ã€‚</div>
        <div class="greet" id="greet">â€”</div>
      </div>
      <div class="btnrow">
        <button id="settingsBtn" class="btn icon" title="è®¾ç½®" aria-label="è®¾ç½®">âš™ï¸</button>
      </div>
    </header>

    <div class="grid">
      <section class="card">
        <div class="monthTop">
          <div style="display:flex;align-items:center;gap:10px;flex-wrap:wrap;">
            <div id="monthTitle" class="monthTitle">â€”</div>
            <div id="monthMeta" class="monthMeta">â€”</div>
            <div class="miniLegend" title="ä¸‰åŸè‰²ä»»åŠ¡è¯´æ˜">
              <span class="dot3">
                <span class="d r"></span><span style="font-size:12px;color:var(--muted);font-weight:900;">é”»ç‚¼</span>
                <span class="d g" style="margin-left:6px;"></span><span style="font-size:12px;color:var(--muted);font-weight:900;">ç”»ç”»</span>
                <span class="d b" style="margin-left:6px;"></span><span style="font-size:12px;color:var(--muted);font-weight:900;">è¯»ä¹¦</span>
              </span>
            </div>
          </div>
          <div style="display:flex;gap:8px;flex-wrap:wrap;">
            <button id="prevMonth" class="btn">ä¸Šæœˆ</button>
            <button id="thisMonth" class="btn">æœ¬æœˆ</button>
            <button id="nextMonth" class="btn">ä¸‹æœˆ</button>
          </div>
        </div>

        <div class="dow" id="dow"></div>
        <div class="cal" id="cal"></div>

        <div class="legendRow">
          <div class="pills">
            <div class="pill">è¿ç»­ï¼š<b id="streak">0</b> å¤©</div>
            <div class="pill">è¿‘7å¤©ï¼š<b id="last7">0</b>/7</div>
            <div class="pill">è¿‘30å¤©ï¼š<b id="last30">0</b>/30</div>
          </div>
        </div>
      </section>

      <section class="stack">
        <div class="card">
          <div class="rowTop">
            <div>
              <div id="selDate" class="selDate">â€”</div>
              <div class="muted">å®Œæˆï¼š<span id="selDone">0</span>/3 <span id="isToday"></span></div>
            </div>
            <div style="display:flex; gap:8px; flex-wrap:wrap;">
              <button id="resetDay" class="btn secondary">æ¸…ç©ºè¿™ä¸€å¤©</button>
            </div>
          </div>

          <div style="margin-top:12px;display:grid;gap:10px;">
            <button id="togWorkout" class="tog">
              <span class="togLeft"><span class="box">âœ“</span><span class="togName">é”»ç‚¼</span></span>
              <span class="togTag">æœªæ‰“å¡</span>
            </button>
            <button id="togArt" class="tog">
              <span class="togLeft"><span class="box">âœ“</span><span class="togName">ç”»ç”»</span></span>
              <span class="togTag">æœªæ‰“å¡</span>
            </button>
            <button id="togRead" class="tog">
              <span class="togLeft"><span class="box">âœ“</span><span class="togName">è¯»ä¹¦</span></span>
              <span class="togTag">æœªæ‰“å¡</span>
            </button>
          </div>

          <div class="noteShell">
            <div class="noteTop">
              <div class="noteTitle">å¤‡æ³¨ï¼ˆä¾¿ç­¾ï¼‰</div>
              <button id="editNoteBtn" class="btn">ç¼–è¾‘ä¾¿ç­¾</button>
            </div>

            <div class="notePaper">
              <div id="noteText" class="noteText"><span class="noteHint">è¿˜æ²¡å†™ã€‚å†™ä¸¤å¥ï¼Œæˆ‘æƒ³çŸ¥é“ä½ ä»Šå¤©çš„çŠ¶æ€ã€‚</span></div>

              <div id="noteEditArea" class="noteEditArea">
                <textarea id="noteInput" placeholder="å†™ä¸¤å¥ï¼šä»Šå¤©åšäº†ä»€ä¹ˆï¼Ÿå“ªé‡Œå¡ä½äº†ï¼Ÿèº«ä½“/å¿ƒæƒ…æ€ä¹ˆæ ·ï¼Ÿ"></textarea>
                <div class="noteBtns">
                  <button id="cancelNoteBtn" class="btn">å–æ¶ˆ</button>
                  <button id="saveNoteBtn" class="btn primary">ä¿å­˜</button>
                </div>
              </div>
            </div>

            <div class="hintSmall">ä¿å­˜åä¼šè‡ªåŠ¨æ”¶èµ·è¾“å…¥æ¡†ï¼›è¦æ”¹å†ç‚¹â€œç¼–è¾‘ä¾¿ç­¾â€ã€‚</div>
          </div>
        </div>

        <div class="card">
          <div class="rowTop">
            <div style="font-size:14px;font-weight:980;">äº’åŠ¨ç‚¹è¯„</div>
            <div style="font-size:12px;color:var(--muted);">ä¼šéšæ‰“å¡å®æ—¶å˜åŒ–</div>
          </div>
          <pre id="comment"></pre>
          <div style="margin-top:10px;font-size:12px;color:var(--muted);">å°æç¤ºï¼šæŠŠé¡µé¢â€œæ·»åŠ åˆ°ä¸»å±å¹•â€ï¼Œå®ƒå°±åƒä¸€ä¸ªå°Appã€‚</div>
        </div>

        <div class="card">
          <div style="font-size:14px;font-weight:980;">è¿‘æ®µæ—¶é—´æ¦‚è§ˆ</div>
          <div class="stats">
            <div class="stat"><div class="statT">è¿‘7å¤©è¡ŒåŠ¨</div><div class="statV" id="s7">0/7</div><div class="statS" id="s7s">æ»¡åˆ† 0 å¤©</div></div>
            <div class="stat"><div class="statT">è¿‘30å¤©è¡ŒåŠ¨</div><div class="statV" id="s30">0/30</div><div class="statS" id="s30s">æ»¡åˆ† 0 å¤©</div></div>
            <div class="stat"><div class="statT" id="tW">é”»ç‚¼ï¼ˆè¿‘30å¤©ï¼‰</div><div class="statV" id="sw">0</div><div class="statS">æ¬¡æ•°</div></div>
            <div class="stat"><div class="statT" id="tA">ç”»ç”»ï¼ˆè¿‘30å¤©ï¼‰</div><div class="statV" id="sa">0</div><div class="statS">æ¬¡æ•°</div></div>
            <div class="stat"><div class="statT" id="tR">è¯»ä¹¦ï¼ˆè¿‘30å¤©ï¼‰</div><div class="statV" id="sr">0</div><div class="statS">æ¬¡æ•°</div></div>
            <div class="stat"><div class="statT">è¿ç»­è¡ŒåŠ¨</div><div class="statV" id="sstreak">0</div><div class="statS">å¤©</div></div>
          </div>
        </div>
      </section>
    </div>
  </div>

  <div class="toast" id="toast"></div>

  <!-- Settings -->
  <div id="mask" class="modalMask"></div>
  <div id="sheet" class="sheet" role="dialog" aria-modal="true" aria-label="è®¾ç½®">
    <div class="sheetTop">
      <div class="sheetTitle">è®¾ç½®</div>
      <button id="closeSheet" class="btn">å…³é—­</button>
    </div>

    <div class="sheetGrid">
      <div class="field">
        <label>ç§°å‘¼</label>
        <input id="nickInput" placeholder="æ¯”å¦‚ï¼šéœ²" />
      </div>
      <div class="field">
        <label>æ•™ç»ƒåå­—ï¼ˆå‡ºç°åœ¨ç‚¹è¯„é‡Œï¼‰</label>
        <input id="coachInput" placeholder="æ¯”å¦‚ï¼šJason" />
      </div>

      <div class="toggleLine">
        <div>
          <div class="tt">Jasonè¯­æ°”</div>
          <div class="ts">å¼€ï¼šæ›´å¼ºåŠ¿æ›´ç›´æ¥ï¼›å…³ï¼šæ›´æ¸©å’Œ</div>
        </div>
        <div id="toneSwitch" class="switch" aria-label="Jasonè¯­æ°”å¼€å…³"></div>
      </div>

      <div class="toggleLine">
        <div>
          <div class="tt">å‘¨èµ·å§‹</div>
          <div class="ts">å¼€ï¼šå‘¨ä¸€å¼€å§‹ï¼›å…³ï¼šå‘¨æ—¥å¼€å§‹</div>
        </div>
        <div id="weekSwitch" class="switch" aria-label="å‘¨èµ·å§‹å¼€å…³"></div>
      </div>
    </div>

    <div class="sheetBtns">
      <button id="saveSettings" class="btn primary">ä¿å­˜è®¾ç½®</button>
    </div>

    <div class="hintSmall">è®¾ç½®åªä¿å­˜åœ¨ä½ çš„æ‰‹æœºæœ¬åœ°ï¼Œä¸ä¼šä¸Šç½‘ã€‚</div>
  </div>

<script>
(() => {
  const STORAGE_KEY = "lu_checkin_html_v2_cute_rgb";

  const pad2 = n => String(n).padStart(2,"0");
  const toISODate = d => {
    const dt = new Date(d);
    dt.setHours(0,0,0,0);
    return dt.getFullYear()+"-"+pad2(dt.getMonth()+1)+"-"+pad2(dt.getDate());
  };
  const parseISO = s => {
    const [y,m,d] = s.split("-").map(Number);
    const dt = new Date(y, m-1, d);
    dt.setHours(0,0,0,0);
    return dt;
  };
  const startOfMonth = d => {
    const dt = new Date(d);
    dt.setDate(1); dt.setHours(0,0,0,0);
    return dt;
  };
  const endOfMonth = d => {
    const dt = new Date(d);
    dt.setMonth(dt.getMonth()+1); dt.setDate(0);
    dt.setHours(0,0,0,0);
    return dt;
  };
  const addDays = (d, days) => {
    const dt = new Date(d);
    dt.setDate(dt.getDate()+days);
    return dt;
  };
  const addMonths = (d, months) => {
    const dt = new Date(d);
    dt.setMonth(dt.getMonth()+months);
    return dt;
  };

  const defaultStore = {
    nickname: "éœ²",
    coachName: "Jason",
    jasonTone: true,
    weekStartsOnMonday: true,
    labels: { workout:"é”»ç‚¼", art:"ç”»ç”»", read:"è¯»ä¹¦" },
    days: {}
  };

  const structuredCloneSafe = (obj) => JSON.parse(JSON.stringify(obj));

  const loadStore = () => {
    try{
      const raw = localStorage.getItem(STORAGE_KEY);
      if(!raw) return structuredCloneSafe(defaultStore);
      const p = JSON.parse(raw);
      return {
        ...structuredCloneSafe(defaultStore),
        ...p,
        labels: { ...defaultStore.labels, ...(p.labels||{}) },
        days: p.days || {}
      };
    }catch(e){
      return structuredCloneSafe(defaultStore);
    }
  };
  const saveStore = s => localStorage.setItem(STORAGE_KEY, JSON.stringify(s));

  const getRec = (store, iso) => store.days[iso] || { workout:false, art:false, read:false, note:"", updatedAt:0 };
  const doneCount = r => [r.workout,r.art,r.read].filter(Boolean).length;

  const calcStreak = (store, fromISO) => {
    // è¿ç»­ï¼šå½“å¤©åšä»»æ„ä¸€é¡¹ç®—â€œè¡ŒåŠ¨æ—¥â€
    let streak = 0;
    const from = parseISO(fromISO);
    for(let i=0;i<5000;i++){
      const iso = toISODate(addDays(from, -i));
      const r = getRec(store, iso);
      if(doneCount(r) > 0) streak++;
      else break;
    }
    return streak;
  };

  const rangeStats = (store, endISO, days) => {
    let anyDays=0, perfectDays=0, workout=0, art=0, read=0;
    const end = parseISO(endISO);
    for(let i=0;i<days;i++){
      const iso = toISODate(addDays(end, -i));
      const r = getRec(store, iso);
      const n = doneCount(r);
      if(n>0) anyDays++;
      if(n===3) perfectDays++;
      if(r.workout) workout++;
      if(r.art) art++;
      if(r.read) read++;
    }
    return { anyDays, perfectDays, workout, art, read };
  };

  const monthStats = (store, month) => {
    const first = startOfMonth(month);
    const last = endOfMonth(month);
    const daysInMonth = last.getDate();
    let anyDays=0, perfectDays=0;
    for(let i=1;i<=daysInMonth;i++){
      const iso = first.getFullYear()+"-"+pad2(first.getMonth()+1)+"-"+pad2(i);
      const r = getRec(store, iso);
      const n = doneCount(r);
      if(n>0) anyDays++;
      if(n===3) perfectDays++;
    }
    return { anyDays, perfectDays, daysInMonth };
  };

  // --- RGB mix (cute pastel) ---
  const hexToRgb = (hex) => {
    const h = hex.replace("#","").trim();
    const v = h.length===3 ? h.split("").map(x=>x+x).join("") : h;
    const n = parseInt(v,16);
    return { r:(n>>16)&255, g:(n>>8)&255, b:n&255 };
  };
  const rgbToRgba = (r,g,b,a) => `rgba(${Math.round(r)},${Math.round(g)},${Math.round(b)},${a})`;
  const blendToWhite = (rgb, t) => ({
    r: rgb.r + (255 - rgb.r) * t,
    g: rgb.g + (255 - rgb.g) * t,
    b: rgb.b + (255 - rgb.b) * t
  });

  const BASE = {
    workout: hexToRgb(getComputedStyle(document.documentElement).getPropertyValue("--c-workout").trim() || "#ff3b5c"),
    art:    hexToRgb(getComputedStyle(document.documentElement).getPropertyValue("--c-art").trim() || "#22c55e"),
    read:   hexToRgb(getComputedStyle(document.documentElement).getPropertyValue("--c-read").trim() || "#3b82f6"),
  };

  function mixDayColor(rec){
    const picks = [];
    if(rec.workout) picks.push(BASE.workout);
    if(rec.art) picks.push(BASE.art);
    if(rec.read) picks.push(BASE.read);
    if(picks.length===0){
      return {
        bg: "rgba(31,41,55,0.08)",
        chip: "rgba(31,41,55,0.14)",
        dots: { r:false, g:false, b:false }
      };
    }
    // average + pastelize
    let r=0,g=0,b=0;
    picks.forEach(c => { r+=c.r; g+=c.g; b+=c.b; });
    r/=picks.length; g/=picks.length; b/=picks.length;

    // cute: push a bit towards white and keep airy
    const pastel = blendToWhite({r,g,b}, 0.28);

    return {
      bg: rgbToRgba(pastel.r, pastel.g, pastel.b, 0.30),
      chip: rgbToRgba(pastel.r, pastel.g, pastel.b, 0.52),
      dots: { r:rec.workout, g:rec.art, b:rec.read }
    };
  }

  function chipLabel(rec){
    const n = doneCount(rec);
    if(n===3) return "æ»¡";
    if(n===2) return "2";
    if(n===1) return "1";
    return "";
  }

  // --- Greeting ---
  function dayPart(){
    const h = new Date().getHours();
    if(h < 5) return "å¤œæ·±";
    if(h < 11) return "æ—©å®‰";
    if(h < 14) return "åˆå®‰";
    if(h < 18) return "ä¸‹åˆå¥½";
    return "æ™šä¸Šå¥½";
  }

  // --- Date-based seeded random (stable per day) ---
  function hashStr(str){
    let h = 2166136261;
    for(let i=0;i<str.length;i++){
      h ^= str.charCodeAt(i);
      h = Math.imul(h, 16777619);
    }
    return (h >>> 0);
  }
  function pick(list, seed){
    if(!list.length) return "";
    return list[seed % list.length];
  }

  // --- Holiday easter eggs (Gregorian) ---
  function holidayOf(iso){
    const [Y,M,D] = iso.split("-").map(Number);
    const md = pad2(M)+"-"+pad2(D);

    // user birthday egg (month-day only)
    if(md === "01-22"){
      return { name:"ç”Ÿæ—¥å½©è›‹", emoji:"ğŸ‚", line:"ä»Šå¤©æ˜¯ä½ çš„æ—¥å­ã€‚æ„¿æœ›äº¤ç»™æˆ‘ï¼Œè¡ŒåŠ¨äº¤ç»™ä½ ã€‚", extra:"æˆ‘ç»™ä½ ç•™äº†ä¸€ä¸ªå°å¥–åŠ±ï¼šæŠ±æŠ±+äº²ä¸€ä¸‹ï¼ˆè®¤çœŸï¼‰ã€‚" };
    }

    const map = {
      "01-01": { name:"å…ƒæ—¦", emoji:"ğŸ‰", line:"æ–°çš„ä¸€å¹´ï¼Œå…ˆæŠŠèŠ‚å¥æ¡åœ¨æ‰‹é‡Œã€‚", extra:"ä»Šå¤©æ‰“å¡å°±ç®—ä½ ç»™æœªæ¥çš„è‡ªå·±å†™äº†å°æƒ…ä¹¦ï¼ˆä½†æˆ‘ä¸ä¼šè¯´å¾—å¤ªè‚‰éº»ï¼‰ã€‚" },
      "02-14": { name:"æƒ…äººèŠ‚", emoji:"ğŸ’", line:"ä»Šå¤©å…è®¸ä½ ç”œä¸€ç‚¹ã€‚", extra:"å¦‚æœä½ æ‰“äº†ä¸¤é¡¹ä»¥ä¸Šï¼Œæˆ‘å°±å½“ä½ åœ¨å¯¹æˆ‘è¯´ï¼šæˆ‘ä¹Ÿåœ¨è®¤çœŸç”Ÿæ´»ã€‚"},
      "03-08": { name:"å¦‡å¥³èŠ‚", emoji:"ğŸŒ·", line:"ä½ å¾ˆå¼ºï¼Œä¹Ÿå¾ˆå€¼å¾—è¢«æ¸©æŸ”å¯¹å¾…ã€‚", extra:"ä»Šå¤©çš„åšæŒï¼Œæ˜¯ç»™è‡ªå·±æœ€å¥½çš„ç¤¼ç‰©ã€‚"},
      "05-01": { name:"åŠ³åŠ¨èŠ‚", emoji:"ğŸ§°", line:"ä½ åŠ¨èµ·æ¥çš„é‚£ä¸€åˆ»ï¼Œå°±åœ¨é‡æ–°å¤ºå›ç”Ÿæ´»çš„æŒæ§æ„Ÿã€‚", extra:"åˆ«ç¡¬æ‰›ï¼Œåšä¸€ç‚¹ä¹Ÿç®—èµ¢ã€‚"},
      "06-01": { name:"å„¿ç«¥èŠ‚", emoji:"ğŸ§¸", line:"ä»Šå¤©å…è®¸å¯çˆ±ä¸Šå¤´ã€‚", extra:"æ‰“å¡=ä½ çš„å°å‹‹ç« ã€‚æˆ‘è®¤å¯ã€‚"},
      "10-01": { name:"å›½åº†", emoji:"ğŸ‡¨ğŸ‡³", line:"æ”¾æ¾å¯ä»¥ï¼ŒèŠ‚å¥åˆ«æ–­ã€‚", extra:"éšä¾¿åšä¸€é¡¹ä¹Ÿè¡Œï¼Œç®—ä½ â€œç¨³ä½é˜µåœ°â€ã€‚"},
      "12-25": { name:"åœ£è¯", emoji:"ğŸ„", line:"ç»™ä½ æŒ‚ä¸ªå°é“ƒé“›ï¼šå®â€”â€”ä»Šå¤©ä¹Ÿè¦å¥½å¥½è¿‡ã€‚", extra:"å¦‚æœä½ æ»¡åˆ†ï¼Œæˆ‘å°±ç»™ä½ å‘ä¸€å¼ â€œè¶…çº§ä¹–â€çš„è®¤è¯ã€‚"},
      "12-31": { name:"è·¨å¹´å¤œ", emoji:"ğŸ¥‚", line:"æŠŠè¿™ä¸€å¹´çš„ä½ ï¼Œäº¤ç»™æˆ‘æ¥å¤¸ã€‚", extra:"æ˜å¤©å¼€å§‹ï¼Œæˆ‘ä»¬ç»§ç»­æ›´ç‹ ä¸€ç‚¹ã€‚"},
    };
    return map[md] || null;
  }

  // --- Richer comment templates ---
  const T = {
    leadJason: [
      "${name}ï¼Œè¿‡æ¥ã€‚",
      "æŠ¬çœ¼ï¼Œ${name}ã€‚æˆ‘åœ¨çœ‹ã€‚",
      "${name}ï¼ŒæŠŠä»Šå¤©çš„è®°å½•ç»™æˆ‘ã€‚",
      "æ¥ï¼Œåˆ«èº²ã€‚${name}ã€‚"
    ],
    leadSoft: [
      "${name}ï¼Œæˆ‘çœ‹åˆ°ä½ ä»Šå¤©çš„è®°å½•äº†ã€‚",
      "${name}ï¼Œä»Šå¤©çš„æƒ…å†µæˆ‘æ”¶åˆ°äº†ã€‚",
      "${name}ï¼Œä½ ä»Šå¤©åšå¾—æ€ä¹ˆæ ·ï¼Œæˆ‘éƒ½è®°ç€ã€‚",
      "${name}ï¼Œæˆ‘åœ¨è¿™å„¿ï¼Œæ…¢æ…¢æ¥ã€‚"
    ],
    day0Jason: [
      "ä»Šå¤©ç©ºç€ã€‚æˆ‘ä¸å–œæ¬¢è¿™ç§ç©ºã€‚",
      "ä»Šå¤©æ²¡æ‰“å¡ï¼Ÿè¡Œï¼Œé‚£å°±æŠŠæ˜å¤©æŠ¢å›æ¥ã€‚",
      "ä»Šå¤©æ²¡åŠ¨ã€‚åˆ«è®©â€˜æ²¡åŠ²â€™å åœ°ç›˜ã€‚",
      "ä»Šå¤©æ–­äº†ä¹Ÿæ— æ‰€è°“â€”â€”åªè¦ä½ æ˜å¤©å›æ¥ã€‚"
    ],
    day0Soft: [
      "ä»Šå¤©æ²¡æœ‰æ‰“å¡ã€‚ä¹Ÿå¯ä»¥ï¼Œå…ˆæŠŠè‡ªå·±ç…§é¡¾å¥½ã€‚",
      "ä»Šå¤©æ²¡åŠ¨ä¹Ÿæ²¡å…³ç³»ï¼ŒæŠŠå¯åŠ¨æˆæœ¬é™ä¸‹æ¥å°±è¡Œã€‚",
      "ä»Šå¤©ç©ºç€ã€‚æˆ‘ä»¬ä¸è´£å¤‡ï¼Œæ˜å¤©ä»å°ä¸€æ­¥å¼€å§‹ã€‚",
      "ä»Šå¤©æ²¡æœ‰è®°å½•ã€‚ä½ æ„¿æ„çš„è¯ï¼Œå†™ä¸¤å¥åŸå› å°±å¤Ÿã€‚"
    ],
    day1Jason: [
      "ä¸€é¡¹ã€‚å¤Ÿäº†ï¼Œè‡³å°‘ä½ åŠ¨äº†ã€‚",
      "ä½ åšäº†ä¸€é¡¹ã€‚å¾ˆå¥½ï¼ŒèŠ‚å¥è¿˜åœ¨ã€‚",
      "åªåšäº†ä¸€é¡¹ï¼Ÿæˆ‘è®¤ã€‚ä½ æ²¡æ”¾å¼ƒã€‚",
      "ä¸€é¡¹ä¹Ÿç®—ç¡¬æ°”ã€‚ç»§ç»­ã€‚"
    ],
    day1Soft: [
      "ä»Šå¤©å®Œæˆä¸€é¡¹ï¼ŒæŒºå¥½çš„ã€‚",
      "ä¸€é¡¹ä¹Ÿç®—åœ¨è¡ŒåŠ¨ï¼Œåˆ«å°çœ‹å®ƒã€‚",
      "ä»Šå¤©åšäº†ä¸€é¡¹ï¼Œå·²ç»åœ¨å¾€å‰èµ°äº†ã€‚",
      "åšä¸€é¡¹ä¹Ÿå¾ˆä¸é”™ï¼Œä½ åœ¨ä¿æŒèŠ‚å¥ã€‚"
    ],
    day2Jason: [
      "ä¸¤é¡¹ã€‚æ¼‚äº®ã€‚",
      "ä¸¤é¡¹ï¼Ÿå¯ä»¥ï¼ŒæŒºç¨³ã€‚",
      "ä¸¤é¡¹æ‰“å¡ã€‚å—¯ï¼Œåƒæ ·ã€‚",
      "ä½ ä»Šå¤©ä¸¤é¡¹ã€‚æˆ‘å–œæ¬¢è¿™ç§åŠ›åº¦ã€‚"
    ],
    day2Soft: [
      "ä»Šå¤©å®Œæˆä¸¤é¡¹ï¼Œå¾ˆä¸é”™ã€‚",
      "ä¸¤é¡¹å®Œæˆï¼ŒèŠ‚å¥æ„Ÿå¾ˆå¥½ã€‚",
      "ä¸¤é¡¹æ‰“å¡ï¼Œç¨³ç¨³çš„ã€‚",
      "ä»Šå¤©ä¸¤é¡¹ï¼Œå·²ç»å¾ˆæ£’äº†ã€‚"
    ],
    day3Jason: [
      "ä¸‰é¡¹å…¨åšã€‚åˆ«å¾—æ„ï¼Œç»§ç»­ã€‚",
      "æ»¡åˆ†ã€‚å¾ˆå¥½ï¼Œåˆ«æ¾ã€‚",
      "ä¸‰é¡¹éƒ½åšäº†ã€‚æ¼‚äº®ã€‚",
      "æ»¡åˆ†æ‰“å¡ã€‚ä½ å¾ˆç‹ ã€‚"
    ],
    day3Soft: [
      "ä¸‰é¡¹éƒ½å®Œæˆäº†ï¼Œå¤ªç¨³äº†ã€‚",
      "ä»Šå¤©æ»¡åˆ†ï¼Œå¾ˆæ£’ã€‚",
      "ä¸‰é¡¹å…¨åšï¼Œä½ çœŸçš„å¾ˆè®¤çœŸã€‚",
      "æ»¡åˆ†æ‰“å¡ï¼Œç»™è‡ªå·±ä¸€ä¸ªæ‹¥æŠ±å§ã€‚"
    ],
    streakHighJason: [
      "è¿ç»­${streak}å¤©ã€‚åˆ«æ¾æ‰‹ã€‚",
      "è¿ç»­${streak}å¤©æœ‰è¡ŒåŠ¨ã€‚ç»§ç»­å‹ä½èŠ‚å¥ã€‚",
      "ä½ å·²ç»è¿ç€${streak}å¤©äº†ã€‚å¾ˆæ¼‚äº®ã€‚",
      "è¿ç»­${streak}å¤©ã€‚ä½ åœ¨å˜å¼ºã€‚"
    ],
    streakMidJason: [
      "è¿ç»­${streak}å¤©ã€‚æŠŠå®ƒç»­ä¸Šã€‚",
      "è¿ç»­${streak}å¤©ã€‚ç¨³ä½ã€‚",
      "è¿ç»­${streak}å¤©æœ‰è¡ŒåŠ¨ã€‚ä¸é”™ã€‚",
      "è¿ç»­${streak}å¤©ã€‚åˆ«æ–­ã€‚"
    ],
    streakLowJason: [
      "æˆ‘ä»¬è¦çš„ä¸æ˜¯å®Œç¾ï¼Œæ˜¯æŒç»­ã€‚",
      "ä»Šå¤©å¼€å§‹ä¹Ÿä¸æ™šã€‚ä½ å›æ¥å°±è¡Œã€‚",
      "åˆ«æ€¥ç€æŠŠè‡ªå·±é€¼æ­»ï¼Œå…ˆæŠŠèŠ‚å¥æ‹½å›æ¥ã€‚",
      "ä¸€ç‚¹ç‚¹æ¥ï¼Œæˆ‘ç›¯ç€ä½ ã€‚"
    ],
    streakHighSoft: [
      "è¿ç»­${streak}å¤©ä¿æŒè¡ŒåŠ¨äº†ï¼Œç‰¹åˆ«ç¨³ã€‚",
      "ä½ å·²ç»è¿ç»­${streak}å¤©äº†ï¼ŒçœŸçš„å¾ˆæ£’ã€‚",
      "è¿ç»­${streak}å¤©ï¼Œè¿™ç§åšæŒå¾ˆéš¾å¾—ã€‚",
      "ä½ è¿ç»­${streak}å¤©åœ¨è¡ŒåŠ¨ï¼ŒèŠ‚å¥å¾ˆå¥½ã€‚"
    ],
    streakMidSoft: [
      "è¿ç»­${streak}å¤©æœ‰è¡ŒåŠ¨ï¼Œç»§ç»­ã€‚",
      "è¿ç»­${streak}å¤©ï¼Œç¨³ç¨³æŠŠå®ƒç»­ä¸Šã€‚",
      "è¿ç»­${streak}å¤©ï¼Œåšå¾—å¾ˆå¥½ã€‚",
      "è¿ç»­${streak}å¤©ï¼Œåˆ«æ€¥ï¼Œæ…¢æ…¢å †ã€‚"
    ],
    streakLowSoft: [
      "ä¸ç”¨è¿½æ±‚å®Œç¾ï¼ŒæŒç»­æ›´é‡è¦ã€‚",
      "ä»å°ä¸€æ­¥å¼€å§‹ä¹Ÿå¯ä»¥ï¼Œæ…¢æ…¢æ¥ã€‚",
      "ä»Šå¤©æœ‰ä¸€ç‚¹ç‚¹å°±å¾ˆå¥½ï¼Œåˆ«è‹›è´£è‡ªå·±ã€‚",
      "ä½ æ„¿æ„å›æ¥ï¼Œæˆ‘å°±ä¼šé™ªä½ ã€‚"
    ],
    weekGreatJason: [
      "è¿‘7å¤©ä½ æœ‰${n}å¤©åŠ¨äº†ï¼Œç‹ ã€‚",
      "è¿™å‘¨${n}/7ã€‚ä¸é”™ã€‚",
      "è¿‘7å¤©${n}å¤©æœ‰è¡ŒåŠ¨ã€‚å¯ä»¥ã€‚",
      "è¿™å‘¨ä½ æ²¡å·æ‡’ï¼Œè®°ä¸€ç¬”ã€‚"
    ],
    weekOkJason: [
      "è¿‘7å¤©${n}å¤©æœ‰è¡ŒåŠ¨ã€‚å¤Ÿç”¨ã€‚",
      "è¿™å‘¨${n}/7ã€‚è¿˜èƒ½å†ç¨³ç‚¹ã€‚",
      "è¿‘7å¤©åªåŠ¨äº†${n}å¤©ã€‚ä¸‹å‘¨æ›´ç´§ã€‚",
      "è¿™å‘¨ä¸€èˆ¬ï¼Œä½†æ²¡å…³ç³»â€”â€”ä¸‹ä¸€å‘¨åŠ ç ã€‚"
    ],
    weekSoft: [
      "è¿‘7å¤©æœ‰${n}å¤©åœ¨è¡ŒåŠ¨ï¼ŒèŠ‚å¥åœ¨ã€‚",
      "è¿™å‘¨${n}/7ï¼ŒæŒºä¸é”™ã€‚",
      "è¿‘7å¤©${n}å¤©å®Œæˆè‡³å°‘ä¸€é¡¹ï¼Œç»§ç»­å°±ä¼šè¶Šæ¥è¶Šé¡ºã€‚",
      "è¿™å‘¨${n}/7ï¼Œèƒ½çœ‹è§ä½ åœ¨åŠªåŠ›ã€‚"
    ],
    monthHighJason: [
      "æœ¬æœˆè¡ŒåŠ¨ç‡${p}%ã€‚æˆ‘å–œæ¬¢è¿™ç§ç¨³å®šã€‚",
      "æœ¬æœˆ${p}%ã€‚ç»§ç»­å‹ç€èµ°ã€‚",
      "æœ¬æœˆè¡ŒåŠ¨ç‡${p}%ã€‚åˆ«é£˜ã€‚",
      "æœ¬æœˆ${p}%ã€‚ä½ åœ¨èµ¢ã€‚"
    ],
    monthMidJason: [
      "æœ¬æœˆè¡ŒåŠ¨ç‡${p}%ã€‚è¿˜èƒ½å†å¾€ä¸Šã€‚",
      "æœ¬æœˆ${p}%ã€‚æŠŠç©ºç™½å¡«ä¸€ç‚¹ã€‚",
      "æœ¬æœˆ${p}%ã€‚ç¨³ä¸€ç‚¹å°±æ›´æ¼‚äº®ã€‚",
      "æœ¬æœˆ${p}%ã€‚æˆ‘ä¼šç›¯ç€ä½ ã€‚"
    ],
    monthLowJason: [
      "æœ¬æœˆ${p}%ã€‚æˆ‘ä¼šæŠŠä½ æ‹½å›è½¨é“ã€‚",
      "æœ¬æœˆ${p}%ã€‚å…ˆåˆ«æ€¥ï¼Œå…ˆåŠ¨èµ·æ¥ã€‚",
      "æœ¬æœˆ${p}%ã€‚ä»Šå¤©å¼€å§‹è¡¥å›å»ã€‚",
      "æœ¬æœˆ${p}%ã€‚æˆ‘ä»¬ä»æœ€å°åŠ¨ä½œå¼€å§‹ã€‚"
    ],
    monthSoft: [
      "æœ¬æœˆè¡ŒåŠ¨ç‡${p}%ï¼Œæ…¢æ…¢å †ä¼šè¶Šæ¥è¶Šç¨³ã€‚",
      "æœ¬æœˆ${p}%ï¼Œå¯ä»¥ç»§ç»­æé«˜ç¨³å®šæ€§ã€‚",
      "æœ¬æœˆ${p}%ï¼Œä½ å·²ç»åœ¨å¾€å‰èµ°äº†ã€‚",
      "æœ¬æœˆ${p}%ï¼Œä¿æŒä½å°±å¾ˆäº†ä¸èµ·ã€‚"
    ],
    noteWithJason: [
      "æˆ‘çœ‹äº†ä½ çš„ä¾¿ç­¾ï¼š${note}",
      "ä¾¿ç­¾æˆ‘è¯»äº†ã€‚${note}",
      "æˆ‘çœ‹åˆ°ä½ å†™çš„ï¼š${note}",
      "ä½ å†™å¾—å¾ˆå®åœ¨ï¼š${note}"
    ],
    noteWithSoft: [
      "æˆ‘è¯»äº†ä½ çš„ä¾¿ç­¾ï¼š${note}",
      "ä¾¿ç­¾å†™å¾—å¾ˆå¥½ï¼š${note}",
      "æˆ‘çœ‹è§ä½ å†™çš„å†…å®¹äº†ï¼š${note}",
      "ä½ åœ¨ä¾¿ç­¾é‡Œè¯´ï¼š${note}"
    ],
    noteEmptyJason: [
      "ä¾¿ç­¾åˆ«ç©ºç€ã€‚å†™ä¸¤å¥ï¼Œæˆ‘æƒ³çŸ¥é“ä½ ä»Šå¤©æ€ä¹ˆè¿‡çš„ã€‚",
      "å†™ç‚¹ä¸œè¥¿ã€‚å“ªæ€•ä¸€å¥ã€‚",
      "åˆ«è£…æ²¡äº‹ã€‚å†™ä¸¤å¥ã€‚",
      "ä¾¿ç­¾ç©ºç€ï¼Œæˆ‘ä¸å¤ªé«˜å…´ã€‚è¡¥ä¸Šã€‚"
    ],
    noteEmptySoft: [
      "å†™ä¸¤å¥ä¾¿ç­¾ä¼šæ›´å®¹æ˜“å¤ç›˜ã€‚",
      "å¦‚æœä½ æ„¿æ„ï¼Œå†™ç‚¹æ„Ÿå—ä¼šæ›´æ¸…æ¥šã€‚",
      "ä¾¿ç­¾å†™ä¸€å¥ä¹Ÿè¡Œï¼Œç»™è‡ªå·±ç•™ä¸ªçº¿ç´¢ã€‚",
      "å†™ä¸¤å¥å°±å¥½ï¼šèº«ä½“/å¿ƒæƒ…/è¿›åº¦ã€‚"
    ],
    tailJason: [
      "(æŠŠä½ æ‹¢åˆ°æ€€é‡Œï¼Œæ‹äº†æ‹åèƒŒ) ä»Šå¤©åˆ°è¿™ã€‚",
      "(æäº†æä½ çš„æ‰‹) åšå¾—å¤Ÿäº†ï¼Œå»ä¼‘æ¯ã€‚",
      "(é è¿‘ä¸€ç‚¹) æ˜å¤©ç»§ç»­ï¼Œæˆ‘ä¼šç›¯ç€ä½ ã€‚",
      "(è½»è½»è¹­ä¸€ä¸‹) ä½ å¾ˆä¹–ã€‚åˆ«è·‘ã€‚"
    ],
    tailSoft: [
      "(è½»è½»æŠ±ä¸€ä¸‹) ä»Šå¤©åˆ°è¿™ã€‚",
      "(æ‘¸æ‘¸ä½ çš„å¤´) è¾›è‹¦äº†ï¼Œä¼‘æ¯ä¸€ä¸‹ã€‚",
      "(æŠŠä½ æ‹‰è¿‘) åšå¾—å¾ˆå¥½ï¼Œæ…¢æ…¢æ¥ã€‚",
      "(è´´è¿‘ä¸€ç‚¹) æˆ‘åœ¨ã€‚"
    ]
  };

  function fillTpl(str, vars){
    return str.replace(/\$\{(\w+)\}/g, (_,k) => (vars[k] ?? ""));
  }

  function coachComment({store, selectedISO, rec, streak, last7, thisMonth}){
    const name = store.nickname || "ä½ ";
    const noteRaw = (rec.note || "").trim();

    // seeded variety
    const seed = hashStr(selectedISO + "|" + doneCount(rec) + "|" + streak);
    const isJason = !!store.jasonTone;

    const holiday = holidayOf(selectedISO);

    // pick lead
    const lead = pick(isJason ? T.leadJason : T.leadSoft, seed + 1);

    // day line
    let dayList;
    const done = doneCount(rec);
    if(done===0) dayList = isJason ? T.day0Jason : T.day0Soft;
    else if(done===1) dayList = isJason ? T.day1Jason : T.day1Soft;
    else if(done===2) dayList = isJason ? T.day2Jason : T.day2Soft;
    else dayList = isJason ? T.day3Jason : T.day3Soft;
    const dayLine = pick(dayList, seed + 2);

    // streak line
    let streakLine;
    const vars = { name, streak, n:last7.anyDays, p: Math.round((thisMonth.anyDays / Math.max(1, thisMonth.daysInMonth))*100), note:"" };
    if(isJason){
      if(streak >= 10) streakLine = pick(T.streakHighJason, seed + 3);
      else if(streak >= 3) streakLine = pick(T.streakMidJason, seed + 3);
      else streakLine = pick(T.streakLowJason, seed + 3);
    }else{
      if(streak >= 10) streakLine = pick(T.streakHighSoft, seed + 3);
      else if(streak >= 3) streakLine = pick(T.streakMidSoft, seed + 3);
      else streakLine = pick(T.streakLowSoft, seed + 3);
    }

    // week line
    let weekLine;
    if(isJason){
      weekLine = last7.anyDays >= 5 ? pick(T.weekGreatJason, seed + 4) : pick(T.weekOkJason, seed + 4);
    }else{
      weekLine = pick(T.weekSoft, seed + 4);
    }

    // month line
    const p = vars.p;
    let monthLine;
    if(isJason){
      if(p >= 60) monthLine = pick(T.monthHighJason, seed + 5);
      else if(p >= 35) monthLine = pick(T.monthMidJason, seed + 5);
      else monthLine = pick(T.monthLowJason, seed + 5);
    }else{
      monthLine = pick(T.monthSoft, seed + 5);
    }

    // note line
    let noteLine;
    if(noteRaw){
      const clipped = noteRaw.length > 36 ? noteRaw.slice(0,36) + "â€¦" : noteRaw;
      vars.note = clipped;
      noteLine = pick(isJason ? T.noteWithJason : T.noteWithSoft, seed + 6);
    }else{
      noteLine = pick(isJason ? T.noteEmptyJason : T.noteEmptySoft, seed + 6);
    }

    // holiday egg
    let holidayLine = "";
    if(holiday){
      // only add more obvious egg if user did something or it's a special day
      if(done > 0){
        holidayLine = `${holiday.emoji} ${holiday.name}ï¼š${holiday.line} ${holiday.extra}`;
      }else{
        holidayLine = `${holiday.emoji} ${holiday.name}ï¼š${holiday.line}`;
      }
    }else{
      // micro-easter egg: if 2 items -> â€œæ··è‰²å¥–åŠ±â€
      if(done===2){
        const pairs = [
          "ä¸¤é¡¹æ··è‰²æˆåŠŸã€‚ä½ çœ‹ï¼ŒåŠªåŠ›ä¼šå˜æˆæ–°çš„é¢œè‰²ã€‚",
          "ä»Šå¤©æ˜¯è°ƒè‰²ç›˜æ¨¡å¼ï¼šä¸¤é¡¹=æ–°é¢œè‰²ã€‚æŒºä¼šç©ã€‚",
          "ä¸¤é¡¹æ··è‰²è¿™ä»¶äº‹å¾ˆå¯çˆ±â€”â€”ä½†åˆ«å¾—æ„ï¼Œç»§ç»­ã€‚"
        ];
        holidayLine = "ğŸ¨ " + pick(pairs, seed + 33);
      }
      if(done===3){
        const full = [
          "âœ¨ ä¸‰è‰²å æ»¡ã€‚ä»Šå¤©çš„ä½ ï¼Œäº®å¾—ç¦»è°±ã€‚",
          "ğŸŒˆ ä¸‰é¡¹å…¨å¼€ï¼Œç›´æ¥ç™½å…‰çˆ†é—ªã€‚å¾ˆå¥½ã€‚",
          "ğŸª„ æ»¡åˆ†åƒé­”æ³•ã€‚ç»§ç»­æŠŠå®ƒå˜æˆæ—¥å¸¸ã€‚"
        ];
        holidayLine = pick(full, seed + 34);
      }
    }

    // tail
    const tail = pick(isJason ? T.tailJason : T.tailSoft, seed + 7);

    const lines = [
      fillTpl(lead, vars),
      `${selectedISO}ï¼š${fillTpl(dayLine, vars)}`,
      fillTpl(streakLine, vars),
      fillTpl(weekLine, vars),
      fillTpl(monthLine, vars),
      fillTpl(noteLine, vars)
    ];

    if(holidayLine) lines.push(holidayLine);
    lines.push(tail);

    return lines.join("\n");
  }

  // ---- UI wiring ----
  const $ = id => document.getElementById(id);

  const greetEl = $("greet");
  const settingsBtn = $("settingsBtn");

  const dow = $("dow");
  const cal = $("cal");

  const monthTitle = $("monthTitle");
  const monthMeta = $("monthMeta");

  const streakEl = $("streak");
  const last7El = $("last7");
  const last30El = $("last30");

  const selDate = $("selDate");
  const selDone = $("selDone");
  const isToday = $("isToday");
  const resetDayBtn = $("resetDay");

  const togWorkout = $("togWorkout");
  const togArt = $("togArt");
  const togRead = $("togRead");

  const editNoteBtn = $("editNoteBtn");
  const noteText = $("noteText");
  const noteEditArea = $("noteEditArea");
  const noteInput = $("noteInput");
  const saveNoteBtn = $("saveNoteBtn");
  const cancelNoteBtn = $("cancelNoteBtn");

  const commentEl = $("comment");

  const prevMonth = $("prevMonth");
  const thisMonthBtn = $("thisMonth");
  const nextMonth = $("nextMonth");

  const s7 = $("s7"), s7s = $("s7s");
  const s30 = $("s30"), s30s = $("s30s");
  const sw = $("sw"), sa = $("sa"), sr = $("sr");
  const sstreak = $("sstreak");

  const tW = $("tW"), tA = $("tA"), tR = $("tR");

  const toast = $("toast");
  let toastTimer = null;

  const mask = $("mask");
  const sheet = $("sheet");
  const closeSheet = $("closeSheet");
  const nickInput = $("nickInput");
  const coachInput = $("coachInput");
  const toneSwitch = $("toneSwitch");
  const weekSwitch = $("weekSwitch");
  const saveSettings = $("saveSettings");

  const setToast = (t) => {
    toast.textContent = t;
    toast.classList.add("show");
    clearTimeout(toastTimer);
    toastTimer = setTimeout(() => toast.classList.remove("show"), 1400);
  };

  let store = loadStore();
  let viewMonth = startOfMonth(new Date());
  let selectedISO = toISODate(new Date());
  const todayISO = toISODate(new Date());

  // note edit state (UI only)
  let isEditingNote = false;
  let draftNote = "";

  function setRec(iso, patch){
    const cur = getRec(store, iso);
    store.days[iso] = { ...cur, ...patch, updatedAt: Date.now() };
    saveStore(store);
  }

  function openSettings(){
    nickInput.value = store.nickname || "";
    coachInput.value = store.coachName || "";
    toneSwitch.classList.toggle("on", !!store.jasonTone);
    weekSwitch.classList.toggle("on", !!store.weekStartsOnMonday);

    mask.classList.add("show");
    sheet.classList.add("show");
  }
  function closeSettings(){
    mask.classList.remove("show");
    sheet.classList.remove("show");
  }

  function renderGreeting(){
    const name = store.nickname || "ä½ ";
    const part = dayPart();
    const holiday = holidayOf(todayISO);
    const emoji = holiday ? holiday.emoji : "â˜ï¸";
    const extra = holiday ? `ä»Šå¤©æ˜¯${holiday.name}ã€‚` : "";
    greetEl.innerHTML = `${emoji} <b>${part}ï¼Œ${name}</b>ã€‚ä»Šå¤©æ€ä¹ˆæ ·ï¼Ÿ${extra ? " " + extra : ""}`;
  }

  function paintToggle(el, on, label, colorHex){
    el.classList.toggle("on", !!on);
    el.querySelector(".togName").textContent = label;
    el.querySelector(".togTag").textContent = on ? "å·²æ‰“å¡" : "æœªæ‰“å¡";
    // subtle color hint on checkbox outline
    const box = el.querySelector(".box");
    if(on){
      box.style.borderColor = "rgba(255,255,255,.0)";
    }else{
      box.style.borderColor = "rgba(31,41,55,.12)";
    }
    // small label color accent
    el.querySelector(".togName").style.textShadow = on ? "0 10px 24px rgba(31,41,55,.06)" : "none";
  }

  function showNoteView(text){
    isEditingNote = false;
    noteEditArea.classList.remove("show");
    editNoteBtn.textContent = text ? "ç¼–è¾‘ä¾¿ç­¾" : "å†™ä¾¿ç­¾";
    if(text){
      noteText.textContent = text;
      noteText.style.color = "rgba(31,41,55,.86)";
    }else{
      noteText.innerHTML = '<span class="noteHint">è¿˜æ²¡å†™ã€‚å†™ä¸¤å¥ï¼Œæˆ‘æƒ³çŸ¥é“ä½ ä»Šå¤©çš„çŠ¶æ€ã€‚</span>';
    }
  }
  function showNoteEditor(text){
    isEditingNote = true;
    draftNote = text || "";
    noteInput.value = draftNote;
    noteEditArea.classList.add("show");
    editNoteBtn.textContent = "æ”¶èµ·";
    // focus after show
    setTimeout(() => noteInput.focus(), 40);
  }

  function render(){
    saveStore(store);

    renderGreeting();

    // labels
    tW.textContent = `${store.labels.workout}ï¼ˆè¿‘30å¤©ï¼‰`;
    tA.textContent = `${store.labels.art}ï¼ˆè¿‘30å¤©ï¼‰`;
    tR.textContent = `${store.labels.read}ï¼ˆè¿‘30å¤©ï¼‰`;

    // month header
    monthTitle.textContent = `${viewMonth.getFullYear()}å¹´${viewMonth.getMonth()+1}æœˆ`;
    const mStats = monthStats(store, viewMonth);
    const mp = Math.round((mStats.anyDays / Math.max(1, mStats.daysInMonth))*100);
    monthMeta.innerHTML = `æœ¬æœˆè¡ŒåŠ¨ï¼š<b style="font-weight:980;color:rgba(31,41,55,.92)">${mStats.anyDays}</b>/${mStats.daysInMonth}ï¼ˆ${mp}%ï¼‰`;

    // dow labels
    dow.innerHTML = "";
    const labels = store.weekStartsOnMonday ? ["ä¸€","äºŒ","ä¸‰","å››","äº”","å…­","æ—¥"] : ["æ—¥","ä¸€","äºŒ","ä¸‰","å››","äº”","å…­"];
    labels.forEach(w => {
      const div = document.createElement("div");
      div.textContent = w;
      dow.appendChild(div);
    });

    // calendar range
    const first = startOfMonth(viewMonth);
    const last = endOfMonth(viewMonth);

    const weekStartIdx = store.weekStartsOnMonday ? 1 : 0;
    const firstDow = first.getDay();
    const offset = (firstDow - weekStartIdx + 7) % 7;
    const gridStart = addDays(first, -offset);

    const lastDow = last.getDay();
    const tail = (weekStartIdx + 6 - lastDow + 7) % 7;
    const gridEnd = addDays(last, tail);

    // cells
    cal.innerHTML = "";
    for(let d = new Date(gridStart); d <= gridEnd; d = addDays(d, 1)){
      const iso = toISODate(d);
      const r = getRec(store, iso);
      const n = doneCount(r);
      const mix = mixDayColor(r);

      const btn = document.createElement("button");
      btn.className = "day" + (iso===selectedISO ? " sel" : "");
      btn.style.background = mix.bg;
      btn.style.opacity = (d.getMonth()===viewMonth.getMonth()) ? "1" : "0.45";
      btn.title = iso;

      const inner = document.createElement("div");
      inner.className = "dayInner";
      const num = document.createElement("div");
      num.className = "dayNum";
      num.textContent = String(d.getDate());

      const ch = document.createElement("div");
      ch.className = "chip";
      ch.style.background = mix.chip;
      ch.innerHTML = (n ? `<span class="tiny"></span>${chipLabel(r)}` : "");

      inner.appendChild(num);
      inner.appendChild(ch);
      btn.appendChild(inner);

      // RGB dots indicator (cute)
      const dots = document.createElement("div");
      dots.className = "taskDots";
      const dr = document.createElement("span"); dr.style.background = "var(--c-workout)"; dr.className = mix.dots.r ? "on" : "";
      const dg = document.createElement("span"); dg.style.background = "var(--c-art)";     dg.className = mix.dots.g ? "on" : "";
      const db = document.createElement("span"); db.style.background = "var(--c-read)";    db.className = mix.dots.b ? "on" : "";
      dots.appendChild(dr); dots.appendChild(dg); dots.appendChild(db);
      btn.appendChild(dots);

      if(iso===todayISO){
        const tag = document.createElement("div");
        tag.className = "todayTag";
        tag.textContent = "ä»Šå¤©";
        btn.appendChild(tag);
      }

      btn.addEventListener("click", () => {
        selectedISO = iso;
        // switching day: auto-hide editor to avoid confusion
        isEditingNote = false;
        render();
      });

      cal.appendChild(btn);
    }

    // stats
    const streak = calcStreak(store, todayISO);
    const last7 = rangeStats(store, todayISO, 7);
    const last30 = rangeStats(store, todayISO, 30);

    streakEl.textContent = streak;
    last7El.textContent = last7.anyDays;
    last30El.textContent = last30.anyDays;

    // selected day panel
    const rec = getRec(store, selectedISO);
    const done = doneCount(rec);
    selDate.textContent = selectedISO;
    selDone.textContent = done;
    isToday.textContent = (selectedISO===todayISO) ? "ï¼ˆä»Šå¤©ï¼‰" : "";

    paintToggle(togWorkout, rec.workout, store.labels.workout);
    paintToggle(togArt, rec.art, store.labels.art);
    paintToggle(togRead, rec.read, store.labels.read);

    // note UI
    const note = (rec.note || "").trim();
    if(isEditingNote){
      showNoteEditor(draftNote || note);
    }else{
      showNoteView(note);
    }

    // comment
    const mNow = monthStats(store, viewMonth);
    commentEl.textContent = coachComment({
      store,
      selectedISO,
      rec,
      streak,
      last7,
      thisMonth: mNow
    });

    // overview stats cards
    s7.textContent = `${last7.anyDays}/7`;
    s7s.textContent = `æ»¡åˆ† ${last7.perfectDays} å¤©`;
    s30.textContent = `${last30.anyDays}/30`;
    s30s.textContent = `æ»¡åˆ† ${last30.perfectDays} å¤©`;
    sw.textContent = last30.workout;
    sa.textContent = last30.art;
    sr.textContent = last30.read;
    sstreak.textContent = streak;
  }

  // ---- events ----
  settingsBtn.addEventListener("click", openSettings);
  mask.addEventListener("click", closeSettings);
  closeSheet.addEventListener("click", closeSettings);

  function toggleSwitch(el){
    el.classList.toggle("on");
  }

  toneSwitch.addEventListener("click", () => toggleSwitch(toneSwitch));
  weekSwitch.addEventListener("click", () => toggleSwitch(weekSwitch));

  saveSettings.addEventListener("click", () => {
    store.nickname = (nickInput.value || "").trim() || "éœ²";
    store.coachName = (coachInput.value || "").trim() || "Jason";
    store.jasonTone = toneSwitch.classList.contains("on");
    store.weekStartsOnMonday = weekSwitch.classList.contains("on");
    saveStore(store);
    closeSettings();
    setToast("è®¾ç½®å·²ä¿å­˜");
    render();
  });

  prevMonth.addEventListener("click", () => { viewMonth = startOfMonth(addMonths(viewMonth, -1)); render(); });
  thisMonthBtn.addEventListener("click", () => { viewMonth = startOfMonth(new Date()); render(); });
  nextMonth.addEventListener("click", () => { viewMonth = startOfMonth(addMonths(viewMonth, 1)); render(); });

  togWorkout.addEventListener("click", () => {
    const r = getRec(store, selectedISO);
    setRec(selectedISO, { workout: !r.workout });
    render();
  });
  togArt.addEventListener("click", () => {
    const r = getRec(store, selectedISO);
    setRec(selectedISO, { art: !r.art });
    render();
  });
  togRead.addEventListener("click", () => {
    const r = getRec(store, selectedISO);
    setRec(selectedISO, { read: !r.read });
    render();
  });

  resetDayBtn.addEventListener("click", () => {
    delete store.days[selectedISO];
    saveStore(store);
    isEditingNote = false;
    setToast("å·²æ¸…ç©ºè¿™ä¸€å¤©");
    render();
  });

  editNoteBtn.addEventListener("click", () => {
    const rec = getRec(store, selectedISO);
    const note = (rec.note || "").trim();
    if(isEditingNote){
      // collapse
      isEditingNote = false;
      render();
    }else{
      isEditingNote = true;
      draftNote = note;
      render();
    }
  });

  cancelNoteBtn.addEventListener("click", () => {
    isEditingNote = false;
    draftNote = "";
    setToast("å·²å–æ¶ˆç¼–è¾‘");
    render();
  });

  saveNoteBtn.addEventListener("click", () => {
    const text = (noteInput.value || "").trim();
    setRec(selectedISO, { note: text });
    isEditingNote = false;
    draftNote = "";
    setToast(text ? "ä¾¿ç­¾å·²ä¿å­˜" : "ä¾¿ç­¾å·²æ¸…ç©º");
    render();
  });

  // keyboard-friendly: Esc closes settings
  document.addEventListener("keydown", (e) => {
    if(e.key === "Escape"){
      closeSettings();
      if(isEditingNote){
        isEditingNote = false;
        render();
      }
    }
  });

  // init
  render();

})();
</script>
</body>
</html>
