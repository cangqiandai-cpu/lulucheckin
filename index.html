<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>每日打卡</title>
  <style>
    :root{
      --ink:#0f172a;
      --muted:rgba(15,23,42,.65);
      --border:rgba(15,23,42,.10);
      --card:rgba(255,255,255,.86);
      --shadow:0 10px 30px rgba(15,23,42,.06);
      --bg: linear-gradient(180deg, rgba(241,245,249,1) 0%, rgba(255,255,255,1) 60%, rgba(241,245,249,1) 100%);
      --note-bg:#fef9c3;
      --note-border:#facc15;
    }
    *{box-sizing:border-box}
    body{
      margin:0; min-height:100vh; background:var(--bg); color:var(--ink);
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
    }
    .wrap{max-width:980px; margin:0 auto; padding:16px;}
    header{display:flex; justify-content:space-between; align-items:flex-start; gap:12px; flex-wrap:wrap;}
    h1{margin:0; font-size:22px; letter-spacing:-.2px;}
    .badge{font-size:12px; padding:4px 10px; border-radius:999px; background:rgba(15,23,42,.08); display:inline-flex; align-items:center; gap:8px;}
    .dot{width:10px; height:10px; border-radius:999px; background:var(--ink);}
    .sub{margin-top:6px; font-size:13px; color:rgba(15,23,42,.7);}
    .btnrow{display:flex; gap:8px; align-items:center; flex-wrap:wrap;}
    button{font:inherit}
    .btn{
      border-radius:14px; padding:10px 12px; font-size:12px;
      border:1px solid var(--border); background:rgba(255,255,255,0);
      cursor:pointer; user-select:none;
    }
    .btn.secondary{background:rgba(15,23,42,.06);}
    .btn.small{padding:6px 10px; font-size:12px;}
    .card{
      background:var(--card); border:1px solid var(--border); border-radius:20px; padding:14px;
      box-shadow:var(--shadow); backdrop-filter: blur(8px);
    }
    .grid{display:grid; grid-template-columns: 1fr; gap:12px; margin-top:14px;}
    .monthTop{display:flex; justify-content:space-between; align-items:center; gap:10px; flex-wrap:wrap;}
    .monthTitle{font-size:16px; font-weight:800;}
    .monthMeta{font-size:12px; color:var(--muted);}
    .dow{display:grid; grid-template-columns: repeat(7,1fr); gap:8px; margin:12px 0 8px;}
    .dow div{text-align:center; font-size:12px; color:rgba(15,23,42,.55);}
    .cal{display:grid; grid-template-columns: repeat(7,1fr); gap:8px;}
    .day{
      position:relative; height:44px; border-radius:14px; border:1px solid var(--border);
      overflow:hidden; cursor:pointer; text-align:left; padding:0;
    }
    .day.sel{border:1.5px solid rgba(15,23,42,.9);}
    .dayInner{position:absolute; inset:0; padding:10px; display:flex; align-items:center; justify-content:space-between;}
    .dayNum{font-size:14px; font-weight:800;}
    .chip{
      font-size:12px; padding:2px 8px; border-radius:999px;
      background:rgba(255,255,255,.7); border:1px solid rgba(15,23,42,.08);
    }
    .todayTag{
      position:absolute; left:8px; bottom:6px; font-size:11px; padding:2px 8px; border-radius:999px;
      background:rgba(15,23,42,.85); color:white;
    }
    .legendRow{margin-top:12px; display:flex; justify-content:space-between; align-items:center; gap:10px; flex-wrap:wrap;}
    .pills{display:flex; gap:8px; align-items:center; flex-wrap:wrap;}
    .pill{
      font-size:12px; padding:6px 10px; border-radius:999px;
      border:1px solid var(--border); background:rgba(255,255,255,.75);
    }
    .legend{display:flex; gap:8px; align-items:center; font-size:12px; color:var(--muted); flex-wrap:wrap;}
    .sq{width:12px; height:12px; border-radius:4px; border:1px solid var(--border); display:inline-block;}
    .stack{display:grid; grid-template-columns: 1fr; gap:12px;}
    .rowTop{display:flex; justify-content:space-between; align-items:center; gap:10px; flex-wrap:wrap;}
    .selDate{font-size:15px; font-weight:900;}
    .muted{font-size:13px; color:var(--muted);}
    .tog{display:flex; justify-content:space-between; align-items:center; gap:10px; width:100%;
      border-radius:18px; padding:12px; border:1px solid var(--border);
      background:rgba(255,255,255,.7); cursor:pointer;
    }
    .tog.on{background:rgba(15,23,42,.06);}
    .togLeft{display:flex; align-items:center; gap:10px;}
    .box{
      width:38px; height:38px; border-radius:14px; border:1px solid rgba(15,23,42,.12);
      display:flex; align-items:center; justify-content:center; font-weight:900;
      background:rgba(255,255,255,.9); color:rgba(15,23,42,.4);
    }
    .tog.on .box{background:rgba(15,23,42,.88); color:white;}
    .togName{font-size:14px; font-weight:900;}
    .togTag{
      font-size:12px; padding:6px 10px; border-radius:999px; border:1px solid var(--border);
      background:rgba(255,255,255,.8);
    }
    textarea{
      width:100%; min-height:92px; border-radius:16px; border:1px solid rgba(15,23,42,.12);
      padding:12px; font-size:14px; outline:none; background:rgba(255,255,255,.9);
      resize: vertical;
    }
    pre{
      margin:10px 0 0; white-space:pre-wrap; font-size:13px; line-height:1.55;
      background:rgba(15,23,42,.05); border:1px solid rgba(15,23,42,.08);
      border-radius:18px; padding:12px;
    }
    .stats{margin-top:10px; display:grid; grid-template-columns: repeat(2,1fr); gap:10px;}
    .stat{
      border-radius:18px; border:1px solid var(--border); padding:12px; background:rgba(255,255,255,.72);
    }
    .statT{font-size:12px; color:var(--muted); font-weight:800;}
    .statV{margin-top:6px; font-size:22px; font-weight:950; letter-spacing:-.2px;}
    .statS{margin-top:2px; font-size:12px; color:rgba(15,23,42,.55);}
    .toast{
      position:fixed; left:50%; bottom:18px; transform:translateX(-50%);
      padding:10px 14px; border-radius:999px; background:rgba(15,23,42,.9);
      color:white; font-size:13px; box-shadow:0 10px 30px rgba(15,23,42,.25);
      display:none; z-index:30;
    }
    .toast.show{display:block;}

    /* note / sticky style */
    .notePaper{
      margin-top:4px;
      background:var(--note-bg);
      border:1px solid var(--note-border);
      border-radius:14px;
      padding:10px 12px;
      min-height:64px;
      box-shadow:0 6px 15px rgba(15,23,42,.18);
      font-size:13px;
      line-height:1.5;
      position:relative;
      cursor:pointer;
      overflow-wrap:break-word;
    }
    .notePaper::before{
      content:"";
      position:absolute;
      top:0; left:50%;
      transform:translateX(-50%);
      width:40px; height:6px;
      border-radius:999px;
      background:rgba(249,250,251,.7);
      box-shadow:0 1px 0 rgba(148,163,184,.5);
    }
    .notePaper.empty{color:rgba(15,23,42,.45); font-style:italic;}
    .noteEditArea{margin-top:8px; display:none;}
    .noteActions{margin-top:8px; display:flex; gap:8px; justify-content:flex-end;}

    /* settings overlay */
    .settingsOverlay{
      position:fixed; inset:0; background:rgba(15,23,42,.35);
      display:none; align-items:center; justify-content:center;
      z-index:20;
    }
    .settingsOverlay.show{display:flex;}
    .settingsPanel{
      max-width:320px; width:90%;
    }
    .setGroup{margin-top:10px; display:grid; gap:8px;}
    .setItem{
      display:flex; justify-content:space-between; align-items:center;
      font-size:13px; padding:8px 2px;
    }
    .setItem input{transform:scale(1.1);}
    @media (min-width: 880px){
      .grid{grid-template-columns: 1.2fr .8fr;}
    }
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div>
        <div style="display:flex;align-items:center;gap:10px;">
          <span class="dot"></span>
          <h1>每日打卡</h1>
          <span class="badge">本地保存</span>
        </div>
        <div class="sub">你不需要每天满分。把做过的事留成证据。</div>
      </div>
      <div class="btnrow">
        <button id="settingsBtn" class="btn secondary">⚙ 设置</button>
      </div>
    </header>

    <div class="grid">
      <section class="card">
        <div class="monthTop">
          <div style="display:flex;align-items:center;gap:10px;flex-wrap:wrap;">
            <div id="monthTitle" class="monthTitle">—</div>
            <div id="monthMeta" class="monthMeta">—</div>
          </div>
          <div style="display:flex;gap:8px;flex-wrap:wrap;">
            <button id="prevMonth" class="btn">上月</button>
            <button id="thisMonth" class="btn">本月</button>
            <button id="nextMonth" class="btn">下月</button>
          </div>
        </div>

        <div class="dow" id="dow"></div>
        <div class="cal" id="cal"></div>

        <div class="legendRow">
          <div class="pills">
            <div class="pill">连续：<b id="streak">0</b> 天</div>
            <div class="pill">近7天：<b id="last7">0</b>/7</div>
            <div class="pill">近30天：<b id="last30">0</b>/30</div>
          </div>
          <div class="legend">
            <span style="display:inline-flex;align-items:center;gap:6px;"><span class="sq" id="h0"></span>空</span>
            <span style="display:inline-flex;align-items:center;gap:6px;"><span class="sq" id="h1"></span>1 项</span>
            <span style="display:inline-flex;align-items:center;gap:6px;"><span class="sq" id="h2"></span>2 项</span>
            <span style="display:inline-flex;align-items:center;gap:6px;"><span class="sq" id="h3"></span>3 项</span>
          </div>
        </div>
      </section>

      <section class="stack">
        <div class="card">
          <div class="rowTop">
            <div>
              <div id="selDate" class="selDate">—</div>
              <div class="muted">完成：<span id="selDone">0</span>/3 <span id="isToday"></span></div>
            </div>
            <button id="resetDay" class="btn secondary">清空这一天</button>
          </div>

          <div style="margin-top:12px;display:grid;gap:10px;">
            <button id="togWorkout" class="tog"><span class="togLeft"><span class="box">✓</span><span class="togName">锻炼</span></span><span class="togTag">未打卡</span></button>
            <button id="togArt" class="tog"><span class="togLeft"><span class="box">✓</span><span class="togName">画画</span></span><span class="togTag">未打卡</span></button>
            <button id="togRead" class="tog"><span class="togLeft"><span class="box">✓</span><span class="togName">读书</span></span><span class="togTag">未打卡</span></button>
          </div>

          <div style="margin-top:12px;">
            <div style="font-size:13px;font-weight:900;margin-bottom:8px;">备注</div>
            <div id="noteDisplay" class="notePaper"></div>
            <div id="noteEditArea" class="noteEditArea">
              <textarea id="noteEdit" placeholder="写两句：今天做了什么？哪里卡住了？身体/心情怎么样？"></textarea>
              <div class="noteActions">
                <button id="noteCancel" class="btn small">取消</button>
                <button id="noteSave" class="btn secondary small">保存</button>
              </div>
            </div>
          </div>
        </div>

        <div class="card">
          <div class="rowTop">
            <div style="font-size:14px;font-weight:950;">互动点评</div>
            <div style="font-size:12px;color:var(--muted);">会随打卡实时变化</div>
          </div>
          <pre id="comment"></pre>
          <div style="margin-top:10px;font-size:12px;color:var(--muted);">小提示：把这个页面“添加到主屏幕”，它就像一个小App。</div>
        </div>

        <div class="card">
          <div style="font-size:14px;font-weight:950;">近段时间概览</div>
          <div class="stats">
            <div class="stat"><div class="statT">近7天行动</div><div class="statV" id="s7">0/7</div><div class="statS" id="s7s">满分 0 天</div></div>
            <div class="stat"><div class="statT">近30天行动</div><div class="statV" id="s30">0/30</div><div class="statS" id="s30s">满分 0 天</div></div>
            <div class="stat"><div class="statT">锻炼（近30天）</div><div class="statV" id="sw">0</div><div class="statS">次数</div></div>
            <div class="stat"><div class="statT">画画（近30天）</div><div class="statV" id="sa">0</div><div class="statS">次数</div></div>
            <div class="stat"><div class="statT">读书（近30天）</div><div class="statV" id="sr">0</div><div class="statS">次数</div></div>
            <div class="stat"><div class="statT">连续行动</div><div class="statV" id="sstreak">0</div><div class="statS">天</div></div>
          </div>
        </div>
      </section>
    </div>
  </div>

  <div class="toast" id="toast"></div>

  <!-- 设置面板 -->
  <div class="settingsOverlay" id="settingsOverlay">
    <div class="card settingsPanel">
      <div class="rowTop">
        <div style="font-size:14px;font-weight:950;">设置</div>
        <button id="settingsClose" class="btn small">关闭</button>
      </div>
      <div class="setGroup">
        <label class="setItem">
          <span>Jason 语气</span>
          <input type="checkbox" id="setTone" />
        </label>
        <label class="setItem">
          <span>周一作为每周开始</span>
          <input type="checkbox" id="setWeek" />
        </label>
      </div>
    </div>
  </div>

<script>
(() => {
  const STORAGE_KEY = "lu_checkin_html_v2";

  const pad2 = n => String(n).padStart(2,"0");
  const toISODate = d => {
    const dt = new Date(d);
    dt.setHours(0,0,0,0);
    return dt.getFullYear()+"-"+pad2(dt.getMonth()+1)+"-"+pad2(dt.getDate());
  };
  const parseISO = s => {
    const [y,m,d] = s.split("-").map(Number);
    const dt = new Date(y, m-1, d);
    dt.setHours(0,0,0,0);
    return dt;
  };
  const startOfMonth = d => {
    const dt = new Date(d);
    dt.setDate(1); dt.setHours(0,0,0,0);
    return dt;
  };
  const endOfMonth = d => {
    const dt = new Date(d);
    dt.setMonth(dt.getMonth()+1); dt.setDate(0);
    dt.setHours(0,0,0,0);
    return dt;
  };
  const addDays = (d, days) => {
    const dt = new Date(d);
    dt.setDate(dt.getDate()+days);
    return dt;
  };
  const addMonths = (d, months) => {
    const dt = new Date(d);
    dt.setMonth(dt.getMonth()+months);
    return dt;
  };

  const defaultStore = {
    nickname: "露",
    coachName: "Jason",
    jasonTone: true,
    weekStartsOnMonday: true,
    labels: { workout:"锻炼", art:"画画", read:"读书" },
    days: {}
  };

  const clone = obj => (typeof structuredClone === "function" ? structuredClone(obj) : JSON.parse(JSON.stringify(obj)));

  const loadStore = () => {
    try{
      const raw = localStorage.getItem(STORAGE_KEY);
      if(!raw) return clone(defaultStore);
      const p = JSON.parse(raw);
      return {
        ...clone(defaultStore),
        ...p,
        labels: { ...defaultStore.labels, ...(p.labels||{}) },
        days: p.days || {}
      };
    }catch(e){
      return clone(defaultStore);
    }
  };
  const saveStore = s => localStorage.setItem(STORAGE_KEY, JSON.stringify(s));

  const getRec = (store, iso) => store.days[iso] || { workout:false, art:false, read:false, note:"", updatedAt:0 };
  const doneCount = r => [r.workout,r.art,r.read].filter(Boolean).length;

  const calcStreak = (store, fromISO) => {
    let streak = 0;
    const from = parseISO(fromISO);
    for(let i=0;i<5000;i++){
      const iso = toISODate(addDays(from, -i));
      const r = getRec(store, iso);
      if(doneCount(r) > 0) streak++;
      else break;
    }
    return streak;
  };

  const rangeStats = (store, endISO, days) => {
    let anyDays=0, perfectDays=0, workout=0, art=0, read=0;
    const end = parseISO(endISO);
    for(let i=0;i<days;i++){
      const iso = toISODate(addDays(end, -i));
      const r = getRec(store, iso);
      const n = doneCount(r);
      if(n>0) anyDays++;
      if(n===3) perfectDays++;
      if(r.workout) workout++;
      if(r.art) art++;
      if(r.read) read++;
    }
    return { anyDays, perfectDays, workout, art, read };
  };

  const monthStats = (store, month) => {
    const first = startOfMonth(month);
    const last = endOfMonth(month);
    const daysInMonth = last.getDate();
    let anyDays=0, perfectDays=0;
    for(let i=1;i<=daysInMonth;i++){
      const iso = first.getFullYear()+"-"+pad2(first.getMonth()+1)+"-"+pad2(i);
      const r = getRec(store, iso);
      const n = doneCount(r);
      if(n>0) anyDays++;
      if(n===3) perfectDays++;
    }
    return { anyDays, perfectDays, daysInMonth };
  };

  // colors: 三原色 + 调和
  const dayColor = rec => {
    const colors = [];
    if(rec.workout) colors.push([248,180,180]); // 柔和红
    if(rec.art)     colors.push([187,230,179]); // 柔和绿
    if(rec.read)    colors.push([173,196,235]); // 柔和蓝
    if(colors.length === 0) return "rgba(148,163,184,0.16)";
    let r=0,g=0,b=0;
    colors.forEach(c => { r+=c[0]; g+=c[1]; b+=c[2]; });
    r = Math.round(r/colors.length);
    g = Math.round(g/colors.length);
    b = Math.round(b/colors.length);
    // 往白调一次，饱和度降低一点
    r = Math.round((r+255)/2);
    g = Math.round((g+255)/2);
    b = Math.round((b+255)/2);
    return `rgb(${r},${g},${b})`;
  };

  const coachComment = ({nickname, jasonTone, selectedISO, selectedRec, streak, last7, thisMonth}) => {
    const name = nickname || "你";
    const done = doneCount(selectedRec);
    const note = (selectedRec.note || "").trim();

    const pick = arr => arr[Math.floor(Math.random()*arr.length)];

    const lead = jasonTone
      ? pick([`${name}，过来。`, `${name}，过来这边。`, `${name}，坐好。`])
      : pick([`${name}，我看完你的记录了。`, `${name}，今天的打卡我收到了。`]);

    let dayLine="";
    if(done===3){
      dayLine = jasonTone
        ? pick(["今天三项全做。漂亮。","今天是满格表现，我很满意。"])
        : pick(["今天三项都完成了，很稳。","今天是满格的一天，节奏很好。"]);
    }else if(done===2){
      dayLine = jasonTone
        ? pick(["两项。够硬。","少一项没关系，这个状态我认可。"])
        : pick(["今天完成两项，很不错。","今天做了两项，整体节奏很舒服。"]);
    }else if(done===1){
      dayLine = jasonTone
        ? pick(["只做了一项，但至少你动了。","只有一项，也比躺平强多了。"])
        : pick(["今天完成一项，也算把节奏维持住了。","只做了一项也没关系，关键是没让自己完全停下。"]);
    }else{
      dayLine = jasonTone
        ? pick(["今天空着。我不喜欢你把自己放空。","今天没有任何记录，下次不要再这样放空自己。"])
        : pick(["今天没有打卡，先把原因记下来也行。","今天是空白的一天，也可以当作缓冲，但别连续太多。"]);
    }

    let streakLine="";
    if(streak>=10){
      streakLine = jasonTone
        ? pick([`连续 ${streak} 天有行动。别松。`,`连续 ${streak} 天，你已经不是随便说说的人了。`])
        : pick([`你已经连续 ${streak} 天保持行动了，很厉害。`,`连续 ${streak} 天坚持，已经能看出你的耐心和定力。`]);
    }else if(streak>=3){
      streakLine = jasonTone
        ? pick([`连续 ${streak} 天。把它续上。`,`连续 ${streak} 天，不错，继续往上堆。`])
        : pick([`连续 ${streak} 天有行动，节奏刚刚好。`,`连续 ${streak} 天在动，说明你已经上路了。`]);
    }else{
      streakLine = jasonTone
        ? pick(["我们要的不是完美，是持续。","别急着给自己判输，现在才刚开始。"])
        : pick(["不用追求完美，持续更重要。","一开始节奏不稳很正常，慢慢把频率提上来就好。"]);
    }

    const weekLine = (() => {
      if(last7.anyDays>=6) return jasonTone
        ? pick([`近7天你有 ${last7.anyDays} 天动了，狠。`,`近7天几乎都在动，这种密度我很满意。`])
        : pick([`近7天有 ${last7.anyDays} 天完成至少一项，很棒。`,`近7天几乎都是行动日，你照顾好自己了。`]);
      if(last7.anyDays>=4) return jasonTone
        ? pick([`近7天 ${last7.anyDays} 天有行动。够用。`,`近7天的节奏算合格，我还想看你再往上提一格。`])
        : pick([`近7天有 ${last7.anyDays} 天在行动，节奏不错。`,`近7天的出勤率挺稳定的，可以再稍微往上推一点。`]);
      if(last7.anyDays>=2) return jasonTone
        ? pick([`近7天只动了 ${last7.anyDays} 天。下周我要你更稳。`,`近7天有点松，下周把自己收回来。`])
        : pick([`近7天行动天数偏少，我们一起把节奏找回来。`,`近7天有点散，下周从小目标重新起步。`]);
      return jasonTone
        ? "近7天太空了。你得回来。"
        : "近7天几乎没动，先从最小的一步开始就好。";
    })();

    const p = Math.round((thisMonth.anyDays / Math.max(1, thisMonth.daysInMonth)) * 100);
    const monthLine = (() => {
      if(p>=60) return jasonTone
        ? pick([`本月行动率 ${p}%。我喜欢这种稳定。`,`本月行动率 ${p}%，说明你不是嘴上说说。`])
        : pick([`本月行动率 ${p}%，非常稳定。`,`本月行动率 ${p}%，长期下来会很有感觉。`]);
      if(p>=35) return jasonTone
        ? pick([`本月行动率 ${p}%。还能再往上。`,`本月行动率 ${p}%，勉强过线，再往前推一点。`])
        : pick([`本月行动率 ${p}%，可以继续提高稳定性。`,`本月行动率 ${p}%，已经有基础了，再补几天会更好。`]);
      return jasonTone
        ? pick([`本月行动率 ${p}%。我会把你拽回轨道。`,`本月行动率 ${p}%，下个月我们重新布阵。`])
        : pick([`本月行动率 ${p}%，我们先把起动成本降下来。`,`本月行动率 ${p}%，从最小可执行的动作开始就好。`]);
    })();

    const noteLine = note
      ? (jasonTone
          ? `我看了你的备注：${note.length>32 ? note.slice(0,32)+"…" : note}`
          : `我读了你的备注：${note.length>32 ? note.slice(0,32)+"…" : note}`)
      : (jasonTone
          ? "给我留两句备注。我想知道你今天怎么过的。"
          : "写两句备注会更容易复盘。");

    // 节日彩蛋（公历）
    let holidayLine = "";
    const [,mStr,dStr] = selectedISO.split("-");
    const m = Number(mStr), d = Number(dStr);
    const md = m*100 + d;
    if(md === 101){ // 元旦
      holidayLine = jasonTone
        ? "新的一年从今天开始。今年我会盯着你，一直往前推。"
        : "新的一年从今天开始，把你想坚持的事情一点点写进日历里。";
    }else if(md === 214){ // 情人节
      holidayLine = jasonTone
        ? "情人节。说实话，比起巧克力，我更想看你对自己好一点。"
        : "情人节也算约会日，就当是在跟更好的自己约会。";
    }else if(md === 1225){ // 圣诞
      holidayLine = jasonTone
        ? "圣诞节。今天允许你多偷一点懒，但我还是希望日历上别完全空着。"
        : "圣诞节，哪怕只做一小件事，也算给这一年多点点亮。";
    }else if(md === 131){ // 1 月 31 只是占位，下面是你生日 1.22
      // 占位无事
    }else if(md === 122){ // 你生日
      holidayLine = jasonTone
        ? "今天是你生日。我只说一次：你今年要好好照顾自己，听见没有。"
        : "今天是你生日。谢谢你一路走到这里，也辛苦你了。";
    }

    const tail = jasonTone ? "(把你拢到怀里，拍了拍后背) 今天到这。" : "(轻轻抱一下) 今天到这。";

    const lines = [
      lead,
      `${selectedISO}：${dayLine}`,
      streakLine,
      weekLine,
      monthLine,
      noteLine
    ];
    if(holidayLine) lines.push(holidayLine);
    lines.push(tail);
    return lines.join("\n");
  };

  // ---- UI wiring ----
  const $ = id => document.getElementById(id);

  const settingsBtn = $("settingsBtn");
  const settingsOverlay = $("settingsOverlay");
  const settingsClose = $("settingsClose");
  const setTone = $("setTone");
  const setWeek = $("setWeek");

  const prevMonth = $("prevMonth");
  const thisMonthBtn = $("thisMonth");
  const nextMonth = $("nextMonth");

  const dow = $("dow");
  const cal = $("cal");

  const monthTitle = $("monthTitle");
  const monthMeta = $("monthMeta");

  const streakEl = $("streak");
  const last7El = $("last7");
  const last30El = $("last30");

  const selDate = $("selDate");
  const selDone = $("selDone");
  const isToday = $("isToday");
  const resetDayBtn = $("resetDay");

  const togWorkout = $("togWorkout");
  const togArt = $("togArt");
  const togRead = $("togRead");

  const noteDisplay = $("noteDisplay");
  const noteEditArea = $("noteEditArea");
  const noteEdit = $("noteEdit");
  const noteSave = $("noteSave");
  const noteCancel = $("noteCancel");

  const commentEl = $("comment");

  const s7 = $("s7"), s7s = $("s7s");
  const s30 = $("s30"), s30s = $("s30s");
  const sw = $("sw"), sa = $("sa"), sr = $("sr");
  const sstreak = $("sstreak");

  const toast = $("toast");
  let toastTimer = null;

  const setToast = (t) => {
    toast.textContent = t;
    toast.classList.add("show");
    clearTimeout(toastTimer);
    toastTimer = setTimeout(() => toast.classList.remove("show"), 1400);
  };

  // heat legend 示例：0 空；1 一项；2 两项；3 三项
  $("h0").style.background = "rgba(148,163,184,0.16)";
  $("h1").style.background = dayColor({workout:true,art:false,read:false});
  $("h2").style.background = dayColor({workout:true,art:true,read:false});
  $("h3").style.background = dayColor({workout:true,art:true,read:true});

  let store = loadStore();
  let viewMonth = startOfMonth(new Date());
  let selectedISO = toISODate(new Date());
  const todayISO = toISODate(new Date());
  let editingNote = false;

  const render = () => {
    saveStore(store);

    // month header
    monthTitle.textContent = `${viewMonth.getFullYear()}年${viewMonth.getMonth()+1}月`;
    const mStats = monthStats(store, viewMonth);
    const mp = Math.round((mStats.anyDays / Math.max(1, mStats.daysInMonth))*100);
    monthMeta.textContent = `本月行动：${mStats.anyDays}/${mStats.daysInMonth}（${mp}%）`;

    // dow labels
    dow.innerHTML = "";
    const labels = store.weekStartsOnMonday ? ["一","二","三","四","五","六","日"] : ["日","一","二","三","四","五","六"];
    labels.forEach(w => {
      const div = document.createElement("div");
      div.textContent = w;
      dow.appendChild(div);
    });

    // calendar grid range
    const first = startOfMonth(viewMonth);
    const last = endOfMonth(viewMonth);

    const weekStartIdx = store.weekStartsOnMonday ? 1 : 0;
    const firstDow = first.getDay();
    const offset = (firstDow - weekStartIdx + 7) % 7;
    const gridStart = addDays(first, -offset);

    const lastDow = last.getDay();
    const tail = (weekStartIdx + 6 - lastDow + 7) % 7;
    const gridEnd = addDays(last, tail);

    // cells
    cal.innerHTML = "";
    for(let d = new Date(gridStart); d <= gridEnd; d = addDays(d, 1)){
      const iso = toISODate(d);
      const r = getRec(store, iso);

      const btn = document.createElement("button");
      btn.className = "day" + (iso===selectedISO ? " sel" : "");
      btn.style.background = dayColor(r);
      btn.style.opacity = (d.getMonth()===viewMonth.getMonth()) ? "1" : "0.45";
      btn.title = iso;

      const inner = document.createElement("div");
      inner.className = "dayInner";
      const num = document.createElement("div");
      num.className = "dayNum";
      num.textContent = String(d.getDate());
      const ch = document.createElement("div");
      ch.className = "chip";
      ch.textContent = doneCount(r) ? String(doneCount(r)) : "";
      inner.appendChild(num);
      inner.appendChild(ch);
      btn.appendChild(inner);

      if(iso===todayISO){
        const tag = document.createElement("div");
        tag.className = "todayTag";
        tag.textContent = "今天";
        btn.appendChild(tag);
      }

      btn.addEventListener("click", () => {
        selectedISO = iso;
        editingNote = false;
        render();
      });

      cal.appendChild(btn);
    }

    // top stats
    const streak = calcStreak(store, todayISO);
    const last7 = rangeStats(store, todayISO, 7);
    const last30 = rangeStats(store, todayISO, 30);

    streakEl.textContent = streak;
    last7El.textContent = last7.anyDays;
    last30El.textContent = last30.anyDays;

    // selected day panel
    const rec = getRec(store, selectedISO);
    const done = doneCount(rec);
    selDate.textContent = selectedISO;
    selDone.textContent = done;
    isToday.textContent = (selectedISO===todayISO) ? "（今天）" : "";

    // toggles
    const paintToggle = (el, on, label) => {
      el.classList.toggle("on", !!on);
      el.querySelector(".togName").textContent = label;
      el.querySelector(".togTag").textContent = on ? "已打卡" : "未打卡";
    };
    paintToggle(togWorkout, rec.workout, store.labels.workout);
    paintToggle(togArt, rec.art, store.labels.art);
    paintToggle(togRead, rec.read, store.labels.read);

    // note display
    const text = (rec.note || "").trim();
    noteDisplay.textContent = text || "点击添加备注";
    noteDisplay.classList.toggle("empty", !text);
    noteEdit.value = rec.note || "";
    noteEditArea.style.display = editingNote ? "block" : "none";

    // comment
    commentEl.textContent = coachComment({
      nickname: store.nickname,
      jasonTone: store.jasonTone,
      selectedISO,
      selectedRec: rec,
      streak,
      last7,
      thisMonth: mStats
    });

    // overview stats cards
    s7.textContent = `${last7.anyDays}/7`;
    s7s.textContent = `满分 ${last7.perfectDays} 天`;
    s30.textContent = `${last30.anyDays}/30`;
    s30s.textContent = `满分 ${last30.perfectDays} 天`;
    sw.textContent = last30.workout;
    sa.textContent = last30.art;
    sr.textContent = last30.read;
    sstreak.textContent = streak;

    // settings panel sync
    setTone.checked = !!store.jasonTone;
    setWeek.checked = !!store.weekStartsOnMonday;
  };

  const setRec = (iso, patch) => {
    const cur = getRec(store, iso);
    store.days[iso] = { ...cur, ...patch, updatedAt: Date.now() };
    render();
  };

  // events: calendar controls
  prevMonth.addEventListener("click", () => {
    viewMonth = startOfMonth(addMonths(viewMonth, -1));
    render();
  });
  thisMonthBtn.addEventListener("click", () => {
    viewMonth = startOfMonth(new Date());
    render();
  });
  nextMonth.addEventListener("click", () => {
    viewMonth = startOfMonth(addMonths(viewMonth, 1));
    render();
  });

  // toggles
  togWorkout.addEventListener("click", () => {
    const r = getRec(store, selectedISO);
    setRec(selectedISO, { workout: !r.workout });
  });
  togArt.addEventListener("click", () => {
    const r = getRec(store, selectedISO);
    setRec(selectedISO, { art: !r.art });
  });
  togRead.addEventListener("click", () => {
    const r = getRec(store, selectedISO);
    setRec(selectedISO, { read: !r.read });
  });

  // note: display / edit
  noteDisplay.addEventListener("click", () => {
    editingNote = true;
    noteEditArea.style.display = "block";
    noteEdit.focus();
  });
  noteSave.addEventListener("click", () => {
    setRec(selectedISO, { note: noteEdit.value });
    editingNote = false;
    setToast("备注已保存");
  });
  noteCancel.addEventListener("click", () => {
    editingNote = false;
    render();
  });

  resetDayBtn.addEventListener("click", () => {
    delete store.days[selectedISO];
    editingNote = false;
    setToast("已清空这一天");
    render();
  });

  // settings
  settingsBtn.addEventListener("click", () => {
    settingsOverlay.classList.add("show");
  });
  settingsClose.addEventListener("click", () => {
    settingsOverlay.classList.remove("show");
  });
  settingsOverlay.addEventListener("click", (e) => {
    if(e.target === settingsOverlay) settingsOverlay.classList.remove("show");
  });
  setTone.addEventListener("change", () => {
    store.jasonTone = !!setTone.checked;
    render();
  });
  setWeek.addEventListener("change", () => {
    store.weekStartsOnMonday = !!setWeek.checked;
    render();
  });

  // first render
  render();
})();
</script>
</body>
</html>

